#!/bin/sh /etc/rc.common

START=20
USE_PROCD=1

# Konfigurasi
LOG_FILE="/var/log/jsholat/jsholat.log"
LOG_MAX_SIZE=1048576  # 1MB
LOG_TAG="jsholat-init"
PROG="/usr/bin/jsholat"

# Buat direktori log jika belum ada
[ -d "/var/log/jsholat" ] || mkdir -p "/var/log/jsholat"

# Fungsi Rotasi Log
rotate_log() {
    [ -f "$LOG_FILE" ] || touch "$LOG_FILE"
    if [ $(stat -c%s "$LOG_FILE") -gt $LOG_MAX_SIZE ]; then
        mv "$LOG_FILE" "${LOG_FILE}.old"
        touch "$LOG_FILE"
    fi
}

# Fungsi Logging Terpusat
log() {
    rotate_log
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $LOG_TAG: $1" >> "$LOG_FILE"
    logger -t "$LOG_TAG" "$1"
}

# Trigger Reload
service_triggers() {
    procd_add_reload_trigger "jsholat"
}

start_service() {
   echo "ğŸš€ Memulai service jsholat..."
    local service_status=$(uci -q get jsholat.service.service || echo "0")
    log "âš™ï¸ Memulai service dengan status: $service_status"

    if [ "$service_status" = "1" ]; then
       echo "âœ… Status service: AKTIF"
        log "âš™ï¸ Starting jsholat service..."
        procd_open_instance
        procd_set_param command "$PROG" run
        procd_set_param respawn 300 5 10
        procd_set_param stdout 1
        procd_set_param stderr 1
        procd_close_instance
       echo "ğŸ‰ Service jsholat berhasil diinisialisasi"
    else
        echo "â¸ï¸ Status service: NONAKTIF"
        log "â›” Service dimatikan via konfigurasi"
        echo "ğŸ’¤ Service dinonaktifkan dalam konfigurasi"
    fi
}

stop_service() {
    echo "ğŸ›‘ Menghentikan service jsholat..."
    local pid=$(pgrep -f "/usr/bin/jsholat run")
    log "INFO" "ğŸ”Œ Menghentikan service (PID: ${pid:-Not Running})"
    
    if [ -n "$pid" ]; then
       echo "âš¡ Menghentikan proses dengan PID: $pid"
        if kill "$pid"; then
            log "âœ” Service berhasil dihentikan"
           echo "âœ… Service berhasil dihentikan"
        else
            log "âš ï¸ Gagal menghentikan service (PID: $pid)"
           echo "âŒ Gagal menghentikan service"
        fi
    else
        echo "â„¹ï¸ Tidak ada service jsholat yang berjalan"
    fi
}

reload_service() {
    echo "ğŸ”„ Reloading service jsholat..."
    log "ğŸ” Reloading service..."
    stop_service
    start_service
    echo "âœ¨ Reload service selesai"
}

status_service() {
    echo "ğŸ“Š Memeriksa status service jsholat..."
    "$PROG" status
}

# TAMBAHKAN FUNGSI INFO (UNTUK LUCIDAN OUTPUT JSON)
info_service() {
    "$PROG" info
}