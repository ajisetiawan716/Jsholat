#!/bin/bash

# File: /usr/bin/jsholat-bot
# Versi: 2.6
# Jsholat Bot Manager Script
# (C) 2025 Jsholat - @ajisetiawan716

# Inisiasi pertama kali boot
[ "$1" = "boot" ] && sleep 15

# State management
STATE_FILE="${1:-/tmp/last_update}"
echo "Bot starting with state file: $STATE_FILE" >&2

# Inisiasi log
LOG_FILE="/var/log/jsholat/bot.log"
MAX_LOG_SIZE=1048576  # 1MB
log() {
    local log_message="$1"

    # Persingkat pesan panjang dengan mengambil baris pertama saja
    if [[ "$log_message" == *$'\n'* ]]; then
        log_message=$(echo "$log_message" | head -n 1 | sed 's/ - .*//')
        log_message="$log_message..."
    fi

    # Potong pesan yang terlalu panjang (lebih dari 100 karakter)
    if [ ${#log_message} -gt 100 ]; then
        log_message="${log_message:0:100}..."
    fi
	
	# Rotasi log jika melebihi ukuran maksimal
    if [ -f "$LOG_FILE" ] && [ $(wc -c < "$LOG_FILE") -gt $MAX_LOG_SIZE ]; then
        mv "$LOG_FILE" "$LOG_FILE.old"
        touch "$LOG_FILE"
        chmod 644 "$LOG_FILE"
    fi

    echo "[$(date +"%Y-%m-%d %H:%M:%S")] - $log_message" >> "$LOG_FILE"
}

# Fungsi untuk load config UCI
load_uci_config() {
    # Section: schedule
    SCHEDULE_COUNTRY=$(uci -q get jsholat.schedule.country || echo "Indonesia")
    SCHEDULE_TIMEZONE=$(uci -q get jsholat.schedule.timezone_value || echo "Tidak diatur")
    SCHEDULE_PROVINCE=$(uci -q get jsholat.schedule.province || echo "Tidak diketahui")
    SCHEDULE_CITY_VALUE=$(uci -q get jsholat.schedule.city_value || echo "")
    SCHEDULE_CITY_LABEL=$(uci -q get jsholat.schedule.city_label || echo "")
    SCHEDULE_SOURCE=$(uci -q get jsholat.schedule.source || echo "jadwalsholat")
    SCHEDULE_INTERVAL=$(uci -q get jsholat.schedule.interval || echo "monthly_special")
    SCHEDULE_FILE_JADWAL=$(uci -q get jsholat.schedule.file_jadwal || echo "/usr/share/jsholat/jadwal.txt")
    SCHEDULE_HIJRI_ADJUST=$(uci -q get jsholat.schedule.hijri_adjust || echo "-1")  # Default -1
    
    # Section: sound
    SOUND_VOLUME_CONTROL=$(uci -q get jsholat.sound.volume_control || echo "hardware")
    SOUND_VOLUME_LEVEL=$(uci -q get jsholat.sound.volume_level || echo "60")
    SOUND_MIXER_DEVICE=$(uci -q get jsholat.sound.mixer_device || echo "Speaker")
    SOUND_ADZAN=$(uci -q get jsholat.sound.sound_adzan || echo "/usr/share/jsholat/adzan.mp3")
    SOUND_ADZAN_SHUBUH=$(uci -q get jsholat.sound.sound_adzan_shubuh || echo "/usr/share/jsholat/adzan_subuh.mp3")
    SOUND_ADZAN_IMSY=$(uci -q get jsholat.sound.sound_adzan_imsy || echo "/usr/share/jsholat/tarhim.mp3")
    SOUND_REMINDER_BEFORE=$(uci -q get jsholat.sound.reminder_before || echo "15")
    SOUND_ENABLED=$(uci -q get jsholat.sound.sound_enabled || echo "1")
    
    # Section: service
    SERVICE_ENABLED=$(uci -q get jsholat.service.service || echo "1")
    SERVICE_TELEGRAM_ENABLED=$(uci -q get jsholat.service.telegram_enabled || echo "1")
    TELEGRAM_TOKEN=$(uci -q get jsholat.service.telegram_bot_token || echo "")
    AUTHORIZED_CHAT_ID=$(uci -q get jsholat.service.telegram_chat_id || echo "")
    DEBUG_MODE=$(uci -q get jsholat.service.debug_mode || echo "0")
    SERVICE_AYAT_ENABLED=$(uci -q get jsholat.service.ayat_enabled || echo "0")
}

# Panggil fungsi untuk load config
load_uci_config

# Fungsi untuk mendapatkan status bot (untuk init script)
get_bot_status() {
    local pid_file="/var/run/jsholat-bot.pid"
    
    if [ -f "$pid_file" ]; then
        local pid=$(cat "$pid_file" 2>/dev/null)
        if [ -n "$pid" ] && kill -0 "$pid" 2>/dev/null; then
            # Get uptime dan waktu start
            local uptime_str=""
            local start_time_str="Unknown"
            local memory_usage="Unknown"
            local memory_percent="0"
            
            if [ -d "/proc/$pid" ]; then
                local start_time=$(stat -c %Y /proc/$pid 2>/dev/null || echo 0)
                local now=$(date +%s)
                local uptime=$((now - start_time))
                
                # Hitung uptime
                local days=$((uptime / 86400))
                local hours=$(( (uptime % 86400) / 3600 ))
                local minutes=$(( (uptime % 3600) / 60 ))
                local seconds=$((uptime % 60))
                
                uptime_str="${days}h ${hours}j ${minutes}m ${seconds}d"
                
                # Format waktu start
                if [ "$start_time" -gt 0 ]; then
                    start_time_str=$(date -d "@$start_time" "+%Y-%m-%d %H:%M:%S" 2>/dev/null || \
                                   date -r "$start_time" "+%Y-%m-%d %H:%M:%S" 2>/dev/null || \
                                   echo "Unknown")
                fi
                
                # Ambil informasi memori dari /proc/$pid/status
                if [ -f "/proc/$pid/status" ]; then
                    # Ambil RSS (Resident Set Size) dalam KB
                    local rss_kb=$(grep -E '^VmRSS:' /proc/$pid/status | awk '{print $2}')
                    if [ -n "$rss_kb" ]; then
                        # Konversi ke MB
                        local rss_mb=$((rss_kb / 1024))
                        memory_usage="${rss_mb} MB"
                        
                        # Hitung persentase memori jika total memori tersedia
                        if [ -f "/proc/meminfo" ]; then
                            local total_mem_kb=$(grep -E '^MemTotal:' /proc/meminfo | awk '{print $2}')
                            if [ -n "$total_mem_kb" ] && [ "$total_mem_kb" -gt 0 ]; then
                                memory_percent=$(( (rss_kb * 100) / total_mem_kb ))
                            fi
                        fi
                    fi
                fi
            fi
            
            # Return JSON format for easy parsing
            echo '{
                "status": "running",
                "pid": "'"$pid"'",
                "uptime": "'"$uptime_str"'",
                "start_time": "'"$start_time_str"'",
                "memory_usage": "'"$memory_usage"'",
                "memory_percent": "'"$memory_percent"'",
                "location": "'"${SCHEDULE_CITY_LABEL}, ${SCHEDULE_PROVINCE}"'",
                "timezone": "'"${SCHEDULE_TIMEZONE}"'",
                "source": "'"${SCHEDULE_SOURCE}"'",
                "service": "'"${SERVICE_ENABLED}"'",
                "hijri_adjust": "'"${SCHEDULE_HIJRI_ADJUST}"'",
                "sound": "'"${SOUND_ENABLED}"'",
                "telegram": "'"${SERVICE_TELEGRAM_ENABLED}"'",
                "reminder": "'"${SOUND_REMINDER_BEFORE}"'"
            }'
            return 0
        else
            rm -f "$pid_file"
            echo '{"status": "stopped"}'
            return 1
        fi
    else
        echo '{"status": "stopped"}'
        return 1
    fi
}

# Validasi token (setelah load config)
[ -z "$TELEGRAM_TOKEN" ] && {
    log "ERROR: ‚ùå Token bot Telegram tidak ditemukan!"
    exit 1
}

# PID file untuk monitoring
PID_FILE="/var/run/jsholat-bot.pid"

# Fungsi untuk menulis PID
write_pid() {
    echo $$ > "$PID_FILE"
}

# Fungsi untuk menghapus PID
cleanup_pid() {
    rm -f "$PID_FILE"
}

# Trap untuk cleanup saat exit
trap cleanup_pid EXIT

# Tulis PID saat ini
write_pid

# Trap errors
#trap 'log "ERROR: Script terminated unexpectedly"; exit 1' ERR INT TERM

log "=== Memulai jsholat-bot ==="

# Cek dependensi
if ! command -v jq >/dev/null 2>&1; then
    log "ERROR: jq tidak terinstall. Silakan install package jq terlebih dahulu."
    exit 1
fi

# Fungsi untuk mengecek authorization chat ID
check_authorization() {
    local chat_id="$1"
    
    # Jika telegram_chat_id tidak di-set di config, tolak semua akses (default secure)
    [ -z "$AUTHORIZED_CHAT_ID" ] && return 1
    
    # Cek apakah chat_id sesuai dengan yang di config
    [ "$AUTHORIZED_CHAT_ID" = "$chat_id" ] && return 0
    
    return 1
}

# Test token bot
#if ! curl -s "https://api.telegram.org/bot${TELEGRAM_TOKEN}/getMe" >/dev/null 2>&1; then
#    log "ERROR: Token bot tidak valid atau tidak bisa terhubung ke Telegram API"
#    exit 1
#fi

# Last update id
LAST_UPDATE_ID=0

# Variabel untuk mendapatkan nama kota
CITIES_FILE="/usr/share/jsholat/cities.json"
LOCATION_SEARCH_CACHE="/tmp/jsholat_cache/location_search_cache.json"
LOCATION_SEARCH_FLAG_DIR="/tmp/jsholat_cache/jsholat_search_flags"
mkdir -p "$LOCATION_SEARCH_FLAG_DIR"

# Fungsi untuk info Hijriyah
HIJRI_CACHE_FILE="/tmp/jsholat_cache/hijri_date_cache.json"
HIJRI_CACHE_EXPIRE=3600 # Cache berlaku selama 1 jam (3600 detik)

# Fungsi untuk menulis last update ID ke file state
write_last_update_id() {
    local update_id="$1"
    echo "$update_id" > "$STATE_FILE"
    log "Last update ID saved: $update_id"
}

# Fungsi untuk mendapatkan tanggal Hijriyah dengan cache
get_hijri_date() {
    local gregorian_date=$(date +"%Y-%m-%d")
    local now=$(date +%s)
    
    # Set default jika belum ada di config
    if [ -z "$SCHEDULE_HIJRI_ADJUST" ] || [ "$SCHEDULE_HIJRI_ADJUST" = "" ]; then
        SCHEDULE_HIJRI_ADJUST="-1"
        uci set jsholat.schedule.hijri_adjust="-1"
        uci commit jsholat
    fi
    
    # Cek cache terlebih dahulu
    if [ -f "$HIJRI_CACHE_FILE" ]; then
        local cache_time=$(jq -r '.cache_time' "$HIJRI_CACHE_FILE" 2>/dev/null)
        local cached_date=$(jq -r '.hijri_date' "$HIJRI_CACHE_FILE" 2>/dev/null)
        
        if [ -n "$cache_time" ] && [ -n "$cached_date" ] && 
           [ $((now - cache_time)) -lt $HIJRI_CACHE_EXPIRE ]; then
            echo "$cached_date"
            return 0
        fi
    fi
    
    # Jika cache tidak ada atau sudah expired, ambil dari API
    local adj_value="${SCHEDULE_HIJRI_ADJUST:--1}"  # Gunakan nilai dari config
    local api_url="https://api.myquran.com/v2/cal/hijr/$gregorian_date?adj=$adj_value"
    local response=$(curl -s --max-time 5 "$api_url") # Timeout 5 detik
    local status=$(echo "$response" | jq -r '.status' 2>/dev/null)
    
    if [ "$status" = "true" ]; then
        local hijri_date=$(echo "$response" | jq -r '.data.date[1]' 2>/dev/null)
        
        # Simpan ke cache
        echo "{\"cache_time\":$now,\"hijri_date\":\"$hijri_date\"}" > "$HIJRI_CACHE_FILE"
        echo "$hijri_date"
        return 0
    else
        log "Gagal mendapatkan tanggal Hijriyah dari API"
        # Coba gunakan cache yang expired jika ada
        if [ -n "$cached_date" ]; then
            echo "$cached_date"
            return 1
        else
            echo ""
            return 1
        fi
    fi
}

# Fungsi untuk mencari lokasi
search_location() {
    local query="$1"
    
    if [ ! -f "$CITIES_FILE" ]; then
        log "ERROR: File cities.json tidak ditemukan di $CITIES_FILE"
        return 1
    fi

    # Normalisasi query yang lebih komprehensif
    local norm_query=$(echo "$query" | perl -ne 'print lc' | perl -pe 's/[^a-z0-9 ]//g')
    log "Mencari lokasi dengan query: '$query' (normalized: '$norm_query')"

    # Pencarian utama dengan optimasi
    jq -c --arg q "$norm_query" '
        to_entries[] | 
        .key as $province | 
        .value[] | 
        select(
            (.label | ascii_downcase | index($q)) or
            (.value | index($q))
        ) | {
            province: $province,
            label: .label,
            value: .value,
            timezone: .timezone
        }
    ' "$CITIES_FILE" > "$LOCATION_SEARCH_CACHE"

    # Fallback jika tidak ditemukan
    if [ ! -s "$LOCATION_SEARCH_CACHE" ]; then
        log "Mencoba pencarian alternatif..."
        jq -c --arg q "$norm_query" '
            to_entries[] | 
            .key as $province | 
            .value[] | 
            select(
                (.label | ascii_downcase | test(".*"+$q+".*")) or
                (.value | test(".*"+$q+".*"))
            ) | {
                province: $province,
                label: .label,
                value: .value,
                timezone: .timezone
            }
        ' "$CITIES_FILE" > "$LOCATION_SEARCH_CACHE"
    fi

    if [ -s "$LOCATION_SEARCH_CACHE" ]; then
        log "Ditemukan $(wc -l < "$LOCATION_SEARCH_CACHE") hasil"
        [ "$DEBUG_MODE" = "1" ] && log "Contoh hasil: $(head -n 1 "$LOCATION_SEARCH_CACHE")"
        return 0
    else
        log "Tidak ditemukan hasil untuk: $norm_query"
        log "Daftar kota tersedia:"
        jq -r 'to_entries[] | .key + ": " + (.value[] | .label)' "$CITIES_FILE" | head -n 10 >> "$LOG_FILE"
        return 1
    fi
}

# Fungsi untuk menampilkan hasil pencarian lokasi
show_location_results() {
    local chat_id="$1"
    local message_id="$2"
    local query="$3"
    
    log "Memproses hasil pencarian untuk chat $chat_id, query: '$query'"
    
    # Force reset cache file
    > "$LOCATION_SEARCH_CACHE"

    if ! search_location "$query"; then
        log "Pencarian gagal untuk: $query"
        
        # Ambil contoh kota yang valid
        local example_cities=$(jq -r '.[][0:2].label' "$CITIES_FILE" 2>/dev/null | head -n 3 | grep -v null | tr '\n' ', ' | sed 's/,$//')
        if [ -z "$example_cities" ]; then
            example_cities="Jakarta, Bandung, Surabaya"
        fi
        
        # Langsung gunakan printf dalam send_message
        if [ -z "$message_id" ]; then
            send_message "$chat_id" "$(printf '‚ùå Tidak ditemukan lokasi dengan kata kunci '\''%s'\''\n\nContoh pencarian yang valid: %s\n\nPastikan mengetik nama kota/kabupaten dengan benar.' "$query" "$example_cities")"
        else
            remove_keyboard

 "$chat_id" "$message_id" "$(printf '‚ùå Tidak ditemukan lokasi dengan kata kunci '\''%s'\''\n\nContoh pencarian yang valid: %s\n\nPastikan mengetik nama kota/kabupaten dengan benar.' "$query" "$example_cities")"
        fi
        return 1
    fi

    # Baca hasil pencarian
    local results=$(cat "$LOCATION_SEARCH_CACHE")
    if [ -z "$results" ]; then
        log "ERROR: Hasil pencarian kosong"
        send_message "$chat_id" "‚ùå Data lokasi tidak valid"
        return 1
    fi

    # Bangun keyboard inline
    local keyboard_rows=""
    local first_row=true

    while IFS= read -r result; do
        [ -z "$result" ] && continue

        # Ekstrak data dari JSON
        local province=$(echo "$result" | jq -r '.province')
        local label=$(echo "$result" | jq -r '.label')
        local value=$(echo "$result" | jq -r '.value')
        local timezone=$(echo "$result" | jq -r '.timezone')

        # Bangun teks tombol dan callback data
        local button_text="${label}, ${province} (${timezone})"
        local callback_data="set_location_${value}_${timezone}"

        # Tambahkan ke keyboard
        if [ "$first_row" = false ]; then
            keyboard_rows="${keyboard_rows},"
        else
            first_row=false
        fi

        keyboard_rows="${keyboard_rows}[{\"text\":\"${button_text}\",\"callback_data\":\"${callback_data}\"}]"
    done < "$LOCATION_SEARCH_CACHE"

    # Tambahan tombol Batal
    if [ -n "$keyboard_rows" ]; then
        keyboard_rows="${keyboard_rows},"
    fi
    keyboard_rows="${keyboard_rows}[{\"text\":\"‚ùå Batal\",\"callback_data\":\"cancel_update\"}]"

    local keyboard="[${keyboard_rows}]"
    [ "$DEBUG_MODE" = "1" ] && log "Keyboard yang dibentuk: $keyboard"

    # Validasi keyboard
    if ! echo "$keyboard" | jq empty 2>/dev/null; then
        log "ERROR: Struktur keyboard tidak valid"
        send_message "$chat_id" "‚ùå Terjadi kesalahan saat memproses lokasi"
        return 1
    fi

    # Kirim hasil
    local result_text="üîç Hasil pencarian untuk: *${query}*
Ditemukan $(wc -l < "$LOCATION_SEARCH_CACHE") hasil"
    if [ -z "$message_id" ]; then
        send_inline_keyboard "$chat_id" "$result_text" "$keyboard"
    else
        edit_inline_keyboard "$chat_id" "$message_id" "$result_text" "$keyboard"
    fi
}

# Fungsi untuk membersihkan city_value SAJA (untuk jadwalsholat.org)
clean_city_value() {
    local city_value="$1"
    local source="$2"
    
    if [ "$source" != "jadwalsholat" ]; then
        echo "$city_value"
        return 0
    fi
    
    local original_value="$city_value"
    
    # Step 1: Normalisasi string
    # - Ubah ke lowercase
    # - Hapus titik, spasi ganda, trim
    # - Ubah spasi ke strip
    city_value=$(echo "$city_value" | \
        tr '[:upper:]' '[:lower:]' | \
        tr -d '.' | \
        sed 's/[[:space:]]\+/ /g; s/^[[:space:]]*//; s/[[:space:]]*$//' | \
        sed 's/[[:space:]]/-/g')
    
    # Step 2: Hapus prefix (case insensitive dengan berbagai format)
    city_value=$(echo "$city_value" | sed -E '
        # Hapus kabupaten dengan berbagai variasi
        s/^kabupaten-//
        s/^kab-//
        s/^kabupaten//
        s/^kab//
        
        # Hapus kota dengan berbagai variasi
        s/^kota-//
        s/^kota//
        
        # Hapus singkatan
        s/^k-//
    ')
    
    # Step 3: Gabungkan arah mata angin
    city_value=$(echo "$city_value" | sed -E '
        s/-(barat|utara|timur|selatan|tengah)$/\1/i
        s/-(timur)[-_]?(laut)$/timur\2/i
        s/-(barat)[-_]?(daya|laut)$/barat\2/i
        s/-(selatan)[-_]?(timur)$/selatan\2/i
    ')
    
    # Step 4: Hapus angka dan karakter khusus
    city_value=$(echo "$city_value" | sed -E '
        s/-[0-9]+$//
        s/[^a-z0-9]//g  # Hapus semua karakter non-alphanumeric
    ')
    
    # Log perubahan
    if [ "$original_value" != "$city_value" ]; then
        log "Membersihkan city_value: '$original_value' -> '$city_value'"
    else
        log "Tidak ada perubahan untuk city_value: '$original_value'"
    fi
    
    echo "$city_value"
}

# Fungsi untuk menyimpan lokasi yang dipilih
set_location() {
    local chat_id="$1"
    local message_id="$2"
    local city_value="$3"
    local timezone="$4"
    
    log "Menyimpan lokasi: $city_value, $timezone untuk chat $chat_id"

    # Cari detail lokasi dari cache
    local location_info=$(jq -r --arg val "$city_value" '
        select(.value == $val)' "$LOCATION_SEARCH_CACHE")

    if [ -z "$location_info" ]; then
        log "ERROR: Data lokasi tidak ditemukan di cache"
        remove_keyboard "$chat_id" "$message_id" "‚ùå Gagal menyimpan lokasi. Silakan coba lagi."
        return 1
    fi

    local province=$(echo "$location_info" | jq -r '.province')
    local city_label=$(echo "$location_info" | jq -r '.label')
    local original_city_value="$city_value"
    
    # Bersihkan city_value jika sumber jadwal adalah jadwalsholat
    local cleaned_city_value="$city_value"
    if [ "$SCHEDULE_SOURCE" = "jadwalsholat" ]; then
        cleaned_city_value=$(clean_city_value "$city_value" "$SCHEDULE_SOURCE")
        log "Membersihkan city_value: '$original_city_value' -> '$cleaned_city_value'"
    fi

    # Simpan ke config
    uci set jsholat.schedule.city_label="$city_label"
    uci set jsholat.schedule.province="$province"
    uci set jsholat.schedule.city_value="$cleaned_city_value"
    uci set jsholat.schedule.timezone_value="$timezone"
    uci commit jsholat
	
    # Update variabel config
    SCHEDULE_CITY_LABEL="$city_label"
    SCHEDULE_PROVINCE="$province"
    SCHEDULE_CITY_VALUE="$cleaned_city_value"
    SCHEDULE_TIMEZONE="$timezone"
	
    log "Lokasi disimpan: $city_label, $province ($timezone)"

    # Kirim konfirmasi
    remove_keyboard "$chat_id" "$message_id" "‚úÖ Lokasi berhasil diubah ke: *${city_label}, ${province} (${timezone})*"

    # Update jadwal
    local progress_msg=$(send_message "$chat_id" "üîÑ Memperbarui jadwal sholat untuk lokasi baru...")
    local progress_msg_id=$(echo "$progress_msg" | jq -r '.result.message_id')

    # Proses update dengan logging
    local tmp_file=$(mktemp)
    log "Memulai update jadwal, output disimpan di: $tmp_file"
    /usr/bin/jadwal-update.sh 2>&1 | tee "$tmp_file"

    # Proses output untuk ditampilkan
    while IFS= read -r line; do
        # Bersihkan line dari karakter khusus
        clean_line=$(echo "$line" | sed 's/[[:cntrl:]]//g' | sed 's/"/\\"/g')
        
        curl -s -X POST \
        "https://api.telegram.org/bot${TELEGRAM_TOKEN}/editMessageText" \
        -d chat_id="${chat_id}" \
        -d message_id="${progress_msg_id}" \
        -d text="$(printf 'üîÑ Memperbarui jadwal...\n\n%s' "$clean_line")" \
        -d parse_mode="Markdown" \
        > /dev/null 2>&1
    sleep 0.3
    done < "$tmp_file"


    # Cek hasil update
    if grep -qi "error" "$tmp_file"; then
        local last_error=$(grep -i "error" "$tmp_file" | tail -1 | sed -E 's/^\[[0-9-]+ [0-9:]+\] //')
        send_message "$chat_id" "$(printf '‚ùå Gagal memperbarui jadwal\n\nPesan error: %s\n\nSilakan coba /update manual.' "$last_error")"
    else
        send_message "$chat_id" "‚úÖ Jadwal sholat berhasil diperbarui untuk *${city_label}, ${province}*"
    fi

    rm -f "$tmp_file"
}

# Fungsi untuk menampilkan menu adjustment Hijriyah
show_hijri_adjust_menu() {
    local chat_id="$1"
    local message_id="$2"
    
    # Reload config untuk memastikan nilai terbaru
    load_uci_config
    
    local current_adj="$SCHEDULE_HIJRI_ADJUST"
    
    # Validasi nilai
    if [[ ! "$current_adj" =~ ^[-+][0-9]$|^[0-9]$ ]]; then
        log "Nilai current_adj tidak valid, reset ke -1: $current_adj"
        current_adj="-1"
        uci set jsholat.schedule.hijri_adjust="-1"
        uci commit jsholat
        SCHEDULE_HIJRI_ADJUST="-1"
    fi
    
    local keyboard='[[
        {"text": "-2 '$( [ "$current_adj" = "-2" ] && echo "‚úÖ" )'", "callback_data": "set_hijri_adj_-2"},
        {"text": "-1 '$( [ "$current_adj" = "-1" ] && echo "‚úÖ" )'", "callback_data": "set_hijri_adj_-1"},
        {"text": "0 '$( [ "$current_adj" = "0" ] && echo "‚úÖ" )'", "callback_data": "set_hijri_adj_0"}
    ],[
        {"text": "+1 '$( [ "$current_adj" = "1" ] && echo "‚úÖ" )'", "callback_data": "set_hijri_adj_1"},
        {"text": "+2 '$( [ "$current_adj" = "2" ] && echo "‚úÖ" )'", "callback_data": "set_hijri_adj_2"}
    ],[
        {"text": "‚ùå Batal", "callback_data": "cancel_update"}
    ]]'
    
    local message=$(printf 'üìÖ *Pengaturan Adjust Hijriyah*

*Nilai saat ini:* %s

üìù *Penjelasan:*
‚Ä¢ -2/-1 : Koreksi mundur 1-2 hari
‚Ä¢ 0 : Tanpa koreksi
‚Ä¢ +1/+2 : Koreksi maju 1-2 hari

Contoh: Jika tanggal Hijriyah tampil lebih awal/lambat 1 hari, pilih -1 atau +1 sesuai kebutuhan.' "$current_adj")
    
    if [ -z "$message_id" ]; then
        send_inline_keyboard "$chat_id" "$message" "$keyboard"
    else
        edit_inline_keyboard "$chat_id" "$message_id" "$message" "$keyboard"
    fi
}

# Fungsi untuk menyimpan adjustment Hijriyah
set_hijri_adjust() {
    local chat_id="$1"
    local message_id="$2"
    local adj_value="$3"
    
    # Validasi nilai
    case "$adj_value" in
        "-2"|"-1"|"0"|"1"|"2")
            # Nilai valid
            ;;
        *)
            log "ERROR: Nilai adjustment tidak valid: $adj_value"
            send_message "$chat_id" "‚ùå Nilai adjustment tidak valid. Hanya -2, -1, 0, +1, +2 yang diperbolehkan."
            return 1
            ;;
    esac
    
    uci set jsholat.schedule.hijri_adjust="$adj_value"
    uci commit jsholat
    
    # Update variabel config
    SCHEDULE_HIJRI_ADJUST="$adj_value"
    
    # Hapus cache
    rm -f "$HIJRI_CACHE_FILE"
    
    # Kirim konfirmasi
    remove_keyboard "$chat_id" "$message_id" "‚úÖ Adjustment Hijriyah berhasil diatur ke $adj_value"
    
    log "Adjustment Hijriyah diatur ke $adj_value untuk chat_id=$chat_id"
}

# Fungsi untuk mengirim pesan
send_message() {
    local chat_id="$1"
    local text="$2"
    local parse_mode="${3:-Markdown}"
    
    # Generate JSON payload dengan jq (jika available)
    local json_payload=$(jq -n \
        --arg chat_id "$chat_id" \
        --arg text "$text" \
        --arg parse_mode "$parse_mode" \
        '{
            chat_id: $chat_id,
            text: $text,
            parse_mode: $parse_mode
        }')
    
    log "Mengirim pesan ke chat_id=$chat_id"
    
    local response=$(curl -s -X POST \
        "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
        -H "Content-Type: application/json" \
        -d "$json_payload")
    
    [ "$DEBUG_MODE" = "1" ] && log "Response sendMessage: $response"
    echo "$response"
}

# Fungsi untuk mengirim jadwal bulanan dengan cache fallback dan pengecekan konfigurasi
send_monthly_schedule() {
    local chat_id="$1"
    local cache_dir="/tmp/jsholat_cache"
    local current_month=$(date +%Y%m)
    local cache_file="$cache_dir/jadwal_bulanan_${current_month}.png"
    local temp_file="/tmp/jadwal_bulanan.png"
    local current_date=$(date +%s)
    local cache_expired=0
    local use_cache=0
    local config_changed=0

    log "Mengirim jadwal bulanan ke chat_id=$chat_id"

    # Buat direktori cache jika belum ada
    mkdir -p "$cache_dir"

    # File untuk menyimpan hash konfigurasi terakhir
    local config_hash_file="$cache_dir/last_config.hash"

    # Ambil hash konfigurasi saat ini
    local current_config_hash=$(uci export jsholat | md5sum | cut -d' ' -f1)

    # Cek apakah file cache ada dan valid
    if [ -f "$cache_file" ]; then
        local file_date=$(stat -c %Y "$cache_file")
        local file_age=$(( (current_date - file_date) / 86400 ))  # umur dalam hari
        
        # Cek apakah konfigurasi berubah
        if [ -f "$config_hash_file" ]; then
            local last_config_hash=$(cat "$config_hash_file")
            if [ "$current_config_hash" != "$last_config_hash" ]; then
                config_changed=1
                log "Konfigurasi UCI berubah, perlu generate ulang"
            fi
        fi

        if [ "$file_age" -lt 1 ] && [ "$config_changed" -eq 0 ]; then
            log "Menggunakan gambar dari cache (umur: $file_age hari)"
            use_cache=1
        else
            cache_expired=1
            log "Cache expired atau konfigurasi berubah, akan generate baru"
        fi
    else
        log "Cache tidak ditemukan, akan generate baru"
    fi

    # Jika tidak menggunakan cache, generate gambar baru
    if [ "$use_cache" -eq 0 ]; then
        log "Menjalankan generator jadwal bulanan"
        if ! python3 /usr/bin/jadwal-monthly; then
            log "Gagal generate jadwal bulanan"
            
            # Jika gagal generate, coba gunakan cache yang ada jika tersedia
            if [ -f "$cache_file" ]; then
                log "Fallback ke cache yang tersedia"
                curl -s -X POST \
                    "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendPhoto" \
                    -F chat_id="${chat_id}" \
                    -F photo="@$cache_file" \
                    -F caption="üìÖ Jadwal Sholat Bulan $(date +"%B %Y") (from cache)"
                return $?
            else
                send_message "$chat_id" "‚ùå Gagal membuat jadwal bulanan dan tidak ada cache tersedia"
                return 1
            fi
        fi

        # Verifikasi file output
        if [ ! -f "$temp_file" ]; then
            log "File output tidak ditemukan: $temp_file"
            
            # Coba lagi dengan cache jika ada
            if [ -f "$cache_file" ]; then
                log "Fallback ke cache yang tersedia"
                curl -s -X POST \
                    "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendPhoto" \
                    -F chat_id="${chat_id}" \
                    -F photo="@$cache_file" \
                    -F caption="üìÖ Jadwal Sholat Bulan $(date +"%B %Y") (from cache)"
                return $?
            else
                send_message "$chat_id" "‚ùå Gagal membuat jadwal bulanan"
                return 1
            fi
        fi

        # Update cache dengan file baru
        mv "$temp_file" "$cache_file"
        
        # Simpan hash konfigurasi terbaru
        echo "$current_config_hash" > "$config_hash_file"
        log "Cache dan konfigurasi diperbarui untuk bulan $current_month"
    fi

    # Kirim gambar (baik dari cache atau baru)
    local caption="üìÖ Jadwal Sholat Bulan $(date +"%B %Y")"
    [ "$use_cache" -eq 1 ] && caption="$caption (from cache)"
    [ "$cache_expired" -eq 1 ] && caption="$caption (updated)"
    [ "$config_changed" -eq 1 ] && caption="$caption (config updated)"

    curl -s -X POST \
        "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendPhoto" \
        -F chat_id="${chat_id}" \
        -F photo="@$cache_file" \
        -F caption="$caption"

    return $?
}

# Fungsi untuk mengirim inline keyboard
send_inline_keyboard() {
    local chat_id="$1"
    local text="$2"
    local keyboard="$3"
    
    log "Mengirim inline keyboard ke $chat_id"
    log "Teks: $text"
    [ "$DEBUG_MODE" = "1" ] && log "Keyboard: $keyboard"

    # Bangun payload JSON yang benar
    local payload=$(printf '{
        "chat_id": "%s",
        "text": "%s",
        "parse_mode": "Markdown",
        "reply_markup": {"inline_keyboard": %s}
    }' "$chat_id" "$(echo "$text" | sed 's/"/\\"/g')" "$keyboard")

    [ "$DEBUG_MODE" = "1" ] && log "Payload yang dikirim: $payload"

    local response=$(curl -s -X POST \
        "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
        -H "Content-Type: application/json" \
        -d "$payload")

    [ "$DEBUG_MODE" = "1" ] && log "Response dari Telegram API: $response"

    if ! echo "$response" | jq -e '.ok' >/dev/null; then
        local error_msg=$(echo "$response" | jq -r '.description' 2>/dev/null || echo "Unknown error")
        log "ERROR: Gagal mengirim keyboard - $error_msg"
        return 1
    fi

    return 0
}

# Fungsi untuk mengedit pesan dengan inline keyboard
edit_inline_keyboard() {
    local chat_id="$1"
    local message_id="$2"
    local text="$3"
    local keyboard="$4"
    
    [ "$DEBUG_MODE" = "1" ] && log "Mengedit pesan dengan inline keyboard (message_id=$message_id)"
    
    local response=$(curl -s -X POST \
        "https://api.telegram.org/bot${TELEGRAM_TOKEN}/editMessageText" \
        -d chat_id="${chat_id}" \
        -d message_id="${message_id}" \
        -d text="${text}" \
        -d parse_mode="Markdown" \
        -d reply_markup="{\"inline_keyboard\":${keyboard}}")
    
    [ "$DEBUG_MODE" = "1" ] && log "Response editInlineKeyboard: $response"
    
    if ! echo "$response" | jq -e '.ok' >/dev/null; then
        log "ERROR: Gagal mengedit keyboard - $(echo "$response" | jq -r '.description')"
        send_message "$chat_id" "‚ùå Terjadi kesalahan saat memperbarui pesan"
    fi
}

# Fungsi untuk mengedit pesan (tanpa keyboard)
remove_keyboard() {
    local chat_id="$1"
    local message_id="$2"
    local text="$3"

    [ "$DEBUG_MODE" = "1" ] && log "Menghapus keyboard untuk message_id=$message_id"
    
    curl -s -X POST \
        "https://api.telegram.org/bot${TELEGRAM_TOKEN}/editMessageText" \
        -d chat_id="${chat_id}" \
        -d message_id="${message_id}" \
        -d text="${text}" \
        -d parse_mode="Markdown" \
        > /dev/null 2>&1
}

# Fungsi untuk update status service
update_service_status() {
    local chat_id="$1"
    local message_id="$2"
    local status="$3"
    
    uci set jsholat.service.service="$status"
    uci commit jsholat
    /etc/init.d/jsholat restart
	
	# Update variabel config
    SERVICE_ENABLED="$status"
    
    local status_text=$([ "$status" = "1" ] && echo "diaktifkan" || echo "dinonaktifkan")
    remove_keyboard "$chat_id" "$message_id" "‚úÖ Service jsholat telah $status_text"
}

# Fungsi untuk toggle pengaturan suara
toggle_sound_setting() {
    local chat_id="$1"
    local message_id="$2"
    
    local current_status="$SOUND_ENABLED"
    local new_status=$([ "$current_status" = "1" ] && echo "0" || echo "1")
    
    uci set jsholat.sound.sound_enabled="$new_status"
    uci commit jsholat
	
	# Update variabel config
    SOUND_ENABLED="$new_status"
    
    local status_text=$([ "$new_status" = "1" ] && echo "diaktifkan" || echo "dinonaktifkan")
    remove_keyboard "$chat_id" "$message_id" "üîä Suara adzan telah $status_text"
}

# Fungsi untuk toggle notifikasi Telegram
toggle_telegram_setting() {
    local chat_id="$1"
    local message_id="$2"
    
    local current_status="$SERVICE_TELEGRAM_ENABLED"
    local new_status=$([ "$current_status" = "1" ] && echo "0" || echo "1")
    
    uci set jsholat.service.telegram_enabled="$new_status"
    uci commit jsholat    
	
	# Update variabel config
    SERVICE_TELEGRAM_ENABLED="$new_status"
    
    local status_text=$([ "$new_status" = "1" ] && echo "diaktifkan" || echo "dinonaktifkan")
    remove_keyboard "$chat_id" "$message_id" "üì± Notifikasi Telegram telah $status_text"
}

# Fungsi untuk menampilkan menu durasi reminder
show_reminder_menu() {
    local chat_id="$1"
    local message_id="$2"
    
    local current_reminder="$SOUND_REMINDER_BEFORE"
    
    local keyboard='[[
        {"text": "üîï OFF '$( [ "$current_reminder" = "0" ] && echo "‚úÖ" )'", "callback_data": "set_reminder_0"}
    ],[
        {"text": "5 menit '$( [ "$current_reminder" = "5" ] && echo "‚úÖ" )'", "callback_data": "set_reminder_5"},
        {"text": "10 menit '$( [ "$current_reminder" = "10" ] && echo "‚úÖ" )'", "callback_data": "set_reminder_10"}
    ],[
        {"text": "15 menit '$( [ "$current_reminder" = "15" ] && echo "‚úÖ" )'", "callback_data": "set_reminder_15"}
    ],[
        {"text": "‚ùå Batal", "callback_data": "cancel_update"}
    ]]'
    
    local message=$(printf 'üîî *Pengaturan Pengingat Sholat*\nDurasi saat ini: *%s menit*' "$current_reminder")
    
    if [ -z "$message_id" ]; then
        send_inline_keyboard "$chat_id" "$message" "$keyboard"
    else
        curl -s -X POST \
            "https://api.telegram.org/bot${TELEGRAM_TOKEN}/editMessageText" \
            -d chat_id="${chat_id}" \
            -d message_id="${message_id}" \
            -d text="$message" \
            -d parse_mode="Markdown" \
            -d reply_markup="{\"inline_keyboard\":${keyboard}}" \
            > /dev/null 2>&1
    fi
}

# Fungsi untuk menyimpan durasi reminder
set_reminder_duration() {
    local chat_id="$1"
    local message_id="$2"
    local duration="$3"
    
    uci set jsholat.sound.reminder_before="$duration"
    uci commit jsholat    
	
	# Update variabel config
    SOUND_REMINDER_BEFORE="$duration"
    
    local status_text=""
    if [ "$duration" = "0" ]; then
        status_text="dinonaktifkan"
        log "üîï Reminder dinonaktifkan untuk chat_id=$chat_id"
    else
        status_text="diatur ke ${duration} menit"
        log "üîî Reminder diatur ke ${duration} menit untuk chat_id=$chat_id"
    fi
    
    # Kembali ke menu reminder untuk menunjukkan perubahan
    show_reminder_menu "$chat_id" "$message_id"
}

# Fungsi untuk menampilkan menu pengaturan
show_settings_menu() {
    local chat_id="$1"
    local message_id="$2"
    
    local sound_status="$SOUND_ENABLED"
    local telegram_status="$SERVICE_TELEGRAM_ENABLED"
    local reminder_status="$SOUND_REMINDER_BEFORE"
    
    local sound_text=$([ "$sound_status" = "1" ] && echo "üîä ON" || echo "üîá OFF")
    local telegram_text=$([ "$telegram_status" = "1" ] && echo "üì± ON" || echo "üìµ OFF")
    local reminder_text=$([ "$reminder_status" = "0" ] && echo "üîî OFF" || echo "üîî ${reminder_status}m")
    
    local keyboard='[[
        {"text": "Suara Adzan: '"$sound_text"'", "callback_data": "toggle_sound"}
    ],[
        {"text": "Notifikasi Telegram: '"$telegram_text"'", "callback_data": "toggle_telegram"}
    ],[
        {"text": "Pengingat Sholat: '"$reminder_text"'", "callback_data": "reminder_menu"}
    ],[
        {"text": "‚¨ÖÔ∏è Kembali", "callback_data": "back_to_control"}
    ]]'
    
    if [ -z "$message_id" ]; then
        send_inline_keyboard "$chat_id" "‚öôÔ∏è *Pengaturan Jsholat*" "$keyboard"
    else
        curl -s -X POST \
            "https://api.telegram.org/bot${TELEGRAM_TOKEN}/editMessageText" \
            -d chat_id="${chat_id}" \
            -d message_id="${message_id}" \
            -d text="‚öôÔ∏è *Pengaturan Jsholat*" \
            -d parse_mode="Markdown" \
            -d reply_markup="{\"inline_keyboard\":${keyboard}}" \
            > /dev/null 2>&1
    fi
}

# Fungsi untuk menampilkan menu kontrol
show_control_menu() {
    local chat_id="$1"
    local message_id="$2"
    
    local current_status="$SERVICE_ENABLED"
    local status_text=$([ "$current_status" = "1" ] && echo "AKTIF" || echo "NONAKTIF")
    
    local keyboard='[[
        {"text": "üîò Status: '"$status_text"'", "callback_data": "status"},
        {"text": "‚úÖ Aktifkan", "callback_data": "on"}
    ],[
        {"text": "‚ùå Nonaktifkan", "callback_data": "off"},
        {"text": "‚öôÔ∏è Pengaturan", "callback_data": "settings"}
    ],[
        {"text": "üîä Volume", "callback_data": "volume_menu"},
        {"text": "ü§ñ Status Bot", "callback_data": "bot_status"}
    ],[
        {"text": "‚úîÔ∏è Selesai", "callback_data": "done"}
    ]]'
    
    if [ -z "$message_id" ]; then
        send_inline_keyboard "$chat_id" "üõ† *Kontrol Service Jsholat*" "$keyboard"
    else
        curl -s -X POST \
            "https://api.telegram.org/bot${TELEGRAM_TOKEN}/editMessageText" \
            -d chat_id="${chat_id}" \
            -d message_id="${message_id}" \
            -d text="üõ† *Kontrol Service Jsholat*" \
            -d parse_mode="Markdown" \
            -d reply_markup="{\"inline_keyboard\":${keyboard}}" \
            > /dev/null 2>&1
    fi
}

# Fungsi untuk menampilkan menu pilihan sumber jadwal
show_source_menu() {
    local chat_id="$1"
    local message_id="$2"
    
    local current_source="$SCHEDULE_SOURCE"
    
    local keyboard='[[
        {"text": "JadwalSholat.org '$( [ "$current_source" = "jadwalsholat" ] && echo "‚úÖ" )'", "callback_data": "set_source_jadwalsholat"}
    ],[
        {"text": "AlAdhan API '$( [ "$current_source" = "aladhan" ] && echo "‚úÖ" )'", "callback_data": "set_source_aladhan"}
    ],[
        {"text": "MyQuran API '$( [ "$current_source" = "myquran" ] && echo "‚úÖ" )'", "callback_data": "set_source_myquran"}
    ],[
        {"text": "AjiMedia API '$( [ "$current_source" = "apiajimedia" ] && echo "‚úÖ" )'", "callback_data": "set_source_apiajimedia"}
    ],[
        {"text": "‚ùå Batal", "callback_data": "cancel_update"}
    ]]'
    
    if [ -z "$message_id" ]; then
        send_inline_keyboard "$chat_id" "üåê *Pilih Sumber Jadwal Sholat*" "$keyboard"
    else
        curl -s -X POST \
            "https://api.telegram.org/bot${TELEGRAM_TOKEN}/editMessageText" \
            -d chat_id="${chat_id}" \
            -d message_id="${message_id}" \
            -d text="üåê *Pilih Sumber Jadwal Sholat*" \
            -d parse_mode="Markdown" \
            -d reply_markup="{\"inline_keyboard\":${keyboard}}" \
            > /dev/null 2>&1
    fi
}

# Fungsi untuk mengubah sumber jadwal
set_jadwal_source() {
    local chat_id="$1"
    local message_id="$2"
    local source="$3"
    
    uci set jsholat.schedule.source="$source"
    # Jika sumber adalah aladhan, set method ke 20 (default untuk Indonesia)
    if [ "$source" = "aladhan" ]; then
        uci set jsholat.schedule.method="20"
        log "Mengatur method ke 20 untuk AlAdhan API"
    fi
    
    uci commit jsholat    
	
	# Update variabel config
    SCHEDULE_SOURCE="$source"
    
    local source_name=""
    case "$source" in
        "jadwalsholat") source_name="JadwalSholat.org" ;;
        "aladhan") source_name="AlAdhan API" ;;
        "myquran") source_name="MyQuran API" ;;
        "apiajimedia") source_name="AjiMedia API" ;;
    esac
    
    remove_keyboard "$chat_id" "$message_id" "‚úÖ Sumber jadwal sholat diubah ke *$source_name*
    
    Silahkan lakukan /update jadwal."
    log " ‚úÖ Sumber jadwal sholat diubah ke $source_name"
}

# Fungsi untuk menampilkan menu volume
show_volume_menu() {
    local chat_id="$1"
    local current_volume="$SOUND_VOLUME_LEVEL"
    
    local keyboard='[[
        {"text": "üîá 0%", "callback_data": "set_volume_0"},
        {"text": "üîà 25%", "callback_data": "set_volume_25"},
        {"text": "üîâ 50%", "callback_data": "set_volume_50"}
    ],[
        {"text": "üîä 75%", "callback_data": "set_volume_75"},
        {"text": "üîä 80%", "callback_data": "set_volume_80"},
        {"text": "üîä 85%", "callback_data": "set_volume_85"},
        {"text": "üîä 90%", "callback_data": "set_volume_90"},
        {"text": "üîä 95%", "callback_data": "set_volume_95"},
        {"text": "üì¢ 100%", "callback_data": "set_volume_100"},
        {"text": "üéß Tes Suara", "callback_data": "test_volume"}
    ],[
        {"text": "‚ùå Batal", "callback_data": "cancel_update"}
    ]]'
    
    send_inline_keyboard "$chat_id" "üîä *Pengaturan Volume*\nVolume saat ini: *${current_volume}%*" "$keyboard"
}

# Fungsi untuk menyimpan volume
set_volume() {
    local chat_id="$1"
    local message_id="$2"
    local volume_level="$3"
    
    # Simpan ke config
    uci set jsholat.sound.volume_level="$volume_level"
    uci commit jsholat
	
   # Update variabel config
    SOUND_VOLUME_LEVEL="$volume_level"	
    
    # Terapkan volume (contoh menggunakan alsa)
    amixer -q set Master "${volume_level}%" >/dev/null 2>&1 || true
    
    # Bangun keyboard dengan tombol tes suara
    local keyboard='[[
        {"text": "üéß Tes Suara", "callback_data": "test_volume"},
        {"text": "‚¨ÖÔ∏è Kembali", "callback_data": "set_volume()"}
    ]]'
    
    # Edit pesan untuk menampilkan konfirmasi
    curl -s -X POST \
        "https://api.telegram.org/bot${TELEGRAM_TOKEN}/editMessageText" \
        -d chat_id="${chat_id}" \
        -d message_id="${message_id}" \
        -d text="‚úÖ Volume berhasil diatur ke *${volume_level}%*" \
        -d parse_mode="Markdown" \
        -d reply_markup="{\"inline_keyboard\":${keyboard}}" \
        > /dev/null 2>&1
    
    log "üîä Volume diatur ke ${volume_level}%"
}

# Fungsi untuk menguji suara
test_volume() {
    local chat_id="$1"
    local message_id="$2"
    local volume_level="$SOUND_VOLUME_LEVEL"
    
    # Edit pesan untuk menunjukkan sedang memainkan suara
    curl -s -X POST \
        "https://api.telegram.org/bot${TELEGRAM_TOKEN}/editMessageText" \
        -d chat_id="${chat_id}" \
        -d message_id="${message_id}" \
        -d text="üîä Memainkan suara uji pada volume *${volume_level}%*..." \
        -d parse_mode="Markdown" \
        > /dev/null 2>&1
    
    # Mainkan suara uji
    speaker-test -D default -t sine -f 1000 -l 1 >/dev/null 2>&1
    
    # Edit pesan lagi setelah selesai - TIDAK perlu tombol kembali di sini
    curl -s -X POST \
        "https://api.telegram.org/bot${TELEGRAM_TOKEN}/editMessageText" \
        -d chat_id="${chat_id}" \
        -d message_id="${message_id}" \
        -d text="‚úÖ Tes suara selesai pada volume *${volume_level}%*" \
        -d parse_mode="Markdown" \
        > /dev/null 2>&1
    
    # Tunggu sebentar lalu hapus pesan dan kembali ke volume menu
    sleep 2
    delete_message "$chat_id" "$message_id"
    show_volume_menu "$chat_id"
}

# Tambahkan fungsi delete_message
delete_message() {
    local chat_id="$1"
    local message_id="$2"
    
    curl -s -X POST \
        "https://api.telegram.org/bot${TELEGRAM_TOKEN}/deleteMessage" \
        -d chat_id="${chat_id}" \
        -d message_id="${message_id}" \
        > /dev/null 2>&1
}

# Fungsi untuk konversi waktu dengan detik ke total detik
time_to_seconds_with_sec() {
    local time_str=$1
    
    # Pastikan input tidak kosong
    if [ -z "$time_str" ]; then
        echo "0"
        return 1
    fi
    
    # Hapus semua karakter non-digit dan non-titik dua
    local clean_time=$(echo "$time_str" | tr -cd '0-9:')
    
    # Handle format HH:MM:SS atau HH:MM
    if echo "$clean_time" | grep -qE '^[0-9]{1,2}:[0-9]{2}:[0-9]{2}$'; then
        # Format HH:MM:SS
        local hours=${clean_time%%:*}
        local temp=${clean_time#*:}
        local minutes=${temp%%:*}
        local seconds=${temp#*:}
    elif echo "$clean_time" | grep -qE '^[0-9]{1,2}:[0-9]{2}$'; then
        # Format HH:MM
        local hours=${clean_time%:*}
        local minutes=${clean_time#*:}
        local seconds="00"
    else
        echo "0"
        return 1
    fi
    
    # Hilangkan leading zero
    hours=${hours#0}
    minutes=${minutes#0}
    seconds=${seconds#0}
    
    # Default ke 0 jika kosong
    [ -z "$hours" ] && hours=0
    [ -z "$minutes" ] && minutes=0
    [ -z "$seconds" ] && seconds=0
    
    # Validasi range
    if [ "$hours" -lt 0 ] || [ "$hours" -gt 23 ] || 
       [ "$minutes" -lt 0 ] || [ "$minutes" -gt 59 ] ||
       [ "$seconds" -lt 0 ] || [ "$seconds" -gt 59 ]; then
        echo "0"
        return 1
    fi
    
    echo $(( hours * 3600 + minutes * 60 + seconds ))
    return 0
}


# Fungsi untuk mendapatkan info sholat berikutnya dengan format jam, menit, detik
get_next_prayer_info() {
    local current_time="$1"
    local imsyak="$2"
    local subuh="$3"
    local dzuhur="$4"
    local ashar="$5"
    local magrib="$6"
    local isya="$7"
    
    # Konversi waktu sekarang ke detik
    local current_sec=$(time_to_seconds_with_sec "$current_time")
    local next_prayer=""
    local next_prayer_time=""
    local next_prayer_sec=""

    # Fungsi helper untuk cek waktu sholat berikutnya
    check_next_prayer() {
        local prayer_name="$1"
        local prayer_time="$2"
        # Konversi waktu sholat ke detik (format HH:MM tanpa detik)
        local prayer_sec=$(time_to_seconds_with_sec "$prayer_time")
        
        if [ "$prayer_sec" -gt "$current_sec" ]; then
            if [ -z "$next_prayer_time" ] || [ "$prayer_sec" -lt "$next_prayer_sec" ]; then
                next_prayer="$prayer_name"
                next_prayer_time="$prayer_time"
                next_prayer_sec="$prayer_sec"
            fi
        fi
    }
    
    # Cek semua waktu sholat
    check_next_prayer "Imsyak" "$imsyak"
    check_next_prayer "Subuh" "$subuh"
    check_next_prayer "Dzuhur" "$dzuhur"
    check_next_prayer "Ashar" "$ashar"
    check_next_prayer "Maghrib" "$magrib"
    check_next_prayer "Isya" "$isya"
    
    # Format info waktu berikutnya
    if [ -n "$next_prayer" ]; then
        local time_diff_sec=$(( next_prayer_sec - current_sec ))
        
        # Hitung jam, menit, detik
        local hours=$(( time_diff_sec / 3600 ))
        local minutes=$(( (time_diff_sec % 3600) / 60 ))
        local seconds=$(( time_diff_sec % 60 ))
        
        local next_info="‚è≥ *Sholat berikutnya*: $next_prayer pukul $next_prayer_time"
        
        # Format countdown berdasarkan durasi
        if [ "$hours" -gt 0 ]; then
            # Lebih dari 1 jam: 6j 25m 17d
            next_info+=" (${hours}j ${minutes}m ${seconds}d lagi)"
        elif [ "$minutes" -gt 0 ]; then
            # Kurang dari 1 jam: 25m 17d
            next_info+=" (${minutes}m ${seconds}d lagi)"
        else
            # Kurang dari 1 menit: 17d
            next_info+=" (${seconds}d lagi)"
        fi
        
        echo "$next_info"
    else
        # Jika sudah melewati semua sholat hari ini
        echo "‚è≥ *Sholat berikutnya*: Imsyak (besok pukul $imsyak)"
    fi
}

# Fungsi untuk menampilkan jadwal sholat hari ini
show_daily_schedule() {
    local chat_id="$1"
    
    local day_name=$(date +"%A")
    local day_num=$(date +"%d")
    local month_num=$(date +"%m")
    local month_name=$(date +"%B")
    local year=$(date +"%Y")
    local today=$(date +"%d-%m-%Y")  
    local timezone="$SCHEDULE_TIMEZONE"
    local jadwal_file="$SCHEDULE_FILE_JADWAL"
    
    # Dapatkan waktu saat ini dengan format yang termasuk detik
    local current_time=$(date +"%H:%M:%S")           # 24 jam dengan detik
    local current_time_12h=$(date +"%I:%M:%S %p")    # 12 jam dengan detik
    local current_timestamp=$(date +"%Y-%m-%d %H:%M:%S")  # Full timestamp
    
    # Dapatkan tanggal Hijriyah dengan error handling
    local hijri_date hijri_status
    hijri_date=$(get_hijri_date)
    hijri_status=$?
    
    local hijri_display=""
    if [ -n "$hijri_date" ]; then
        hijri_display="üìÖ *Hijriyah*: $hijri_date"
        if [ $hijri_status -ne 0 ]; then
            hijri_display+=" _(informasi tanggal mungkin tidak terupdate)_"
        fi
    else
        hijri_display="üìÖ *Hijriyah*: (tidak tersedia)"
    fi
    
    # Dapatkan info pembaruan
    local last_updated="Tidak diketahui"
    local data_source="Jadwalsholat.org" # Default value
    local last_updated_file="/usr/share/jsholat/last_updated.txt"
    
    if [ -f "$last_updated_file" ]; then
        # Parse dengan jq (prioritas utama)
        if command -v jq >/dev/null 2>&1; then
            last_updated=$(jq -r '.last_updated // ""' "$last_updated_file" 2>/dev/null)
            data_source=$(jq -r '.data_source // "Jadwalsholat.org"' "$last_updated_file" 2>/dev/null)
        else
            # Fallback ke grep jika jq tidak ada
            last_updated=$(grep -oP '"last_updated"\s*:\s*"([^"]+)"' "$last_updated_file" | cut -d'"' -f4)
            data_source=$(grep -oP '"data_source"\s*:\s*"([^"]+)"' "$last_updated_file" | cut -d'"' -f4)
        fi
    fi

    # Bangun string info pembaruan
    local update_info=""
    update_info="üîÑ Terakhir diperbarui: $last_updated"$'\n'
    source_info="üåê Sumber: $data_source"

    if [ -z "$jadwal_file" ] || [ ! -f "$jadwal_file" ]; then
        local error_msg=$(printf '‚ùå File jadwal tidak ditemukan\n\nCoba /update jadwal.')
		send_message "$chat_id" "$error_msg"
        return 1
    fi
    
    local jadwal=$(grep "^$today" "$jadwal_file" 2>/dev/null)
    if [ -z "$jadwal" ]; then
        send_message "$chat_id" "‚ùå Jadwal sholat hari ini tidak ditemukan"
        return 1
    fi

    local imsyak=$(echo "$jadwal" | awk '{print $2}')
    local subuh=$(echo "$jadwal" | awk '{print $3}')
    local dzuhur=$(echo "$jadwal" | awk '{print $4}')
    local ashar=$(echo "$jadwal" | awk '{print $5}')
    local magrib=$(echo "$jadwal" | awk '{print $6}')
    local isya=$(echo "$jadwal" | awk '{print $7}')
    local lokasi="$SCHEDULE_CITY_LABEL"
    local provinsi="$SCHEDULE_PROVINCE"
    
    # Translate day and month to Indonesian
    case "$day_name" in
        "Monday") day_name="Senin" ;;
        "Tuesday") day_name="Selasa" ;;
        "Wednesday") day_name="Rabu" ;;
        "Thursday") day_name="Kamis" ;;
        "Friday") day_name="Jumat" ;;
        "Saturday") day_name="Sabtu" ;;
        "Sunday") day_name="Ahad" ;;
    esac
    
    case "$month_name" in
        "January") month_name="Januari" ;;
        "February") month_name="Februari" ;;
        "March") month_name="Maret" ;;
        "April") month_name="April" ;;
        "May") month_name="Mei" ;;
        "June") month_name="Juni" ;;
        "July") month_name="Juli" ;;
        "August") month_name="Agustus" ;;
        "September") month_name="September" ;;
        "October") month_name="Oktober" ;;
        "November") month_name="November" ;;
        "December") month_name="Desember" ;;
    esac
    
    # Format tanggal
    local formatted_date="$day_name, $day_num $month_name $year"
    local timezone_display=""
    [ -n "$timezone" ] && timezone_display="($timezone)"

    # Hitung waktu sholat berikutnya
    local next_prayer_info=$(get_next_prayer_info "$current_time" "$imsyak" "$subuh" "$dzuhur" "$ashar" "$magrib" "$isya")

    # Kirim pesan jadwal
    send_message "$chat_id" "üïå *Jadwal Sholat Hari Ini*

üìÜ *Hari/Tanggal*: $formatted_date
üïí *Waktu Sekarang*: $current_time / $current_time_12h
${hijri_display}
üìç *Wilayah*: $lokasi, $provinsi
üåê *Zona Waktu*: $timezone

${next_prayer_info}

üåÑ Imsyak: $imsyak $timezone_display
üåÖ Subuh: $subuh $timezone_display
‚òÄÔ∏è Dzuhur: $dzuhur $timezone_display
üåá Ashar: $ashar $timezone_display
üåÜ Maghrib: $magrib $timezone_display
üåÉ Isya: $isya $timezone_display


$update_info$source_info"

    return 0
}

# Fungsi untuk menampilkan pesan bantuan
send_help_message() {
    local chat_id="$1"
    send_message "$chat_id" "üìö *Daftar Perintah*:
/jadwal - Lihat jadwal sholat hari ini
/jdwlbulan - Lihat jadwal sholat bulan ini
/statusbot - Lihat status detail bot
/setjadwal - Ubah sumber jadwal sholat
/sethijri - Atur koreksi tanggal Hijriyah (-2,-1,0,+1,+2)
/lokasi - Lihat wilayah jadwal saat ini
/setlokasi - Ubah lokasi untuk jadwal sholat
/setvolume - Atur volume suara adzan (0-100)
/reminder - Atur durasi pengingat sholat
/control - Kontrol service jsholat
/status - Lihat status pengaturan
/update - Update jadwal sholat terbaru
/help - Tampilkan bantuan ini"
}

# Fungsi untuk mendapatkan informasi memori sistem dengan format yang mudah dibaca
get_system_memory_info() {
    if [ -f "/proc/meminfo" ]; then
        local total_kb=$(grep -E '^MemTotal:' /proc/meminfo | awk '{print $2}')
        local available_kb=$(grep -E '^MemAvailable:' /proc/meminfo | awk '{print $2}')
        
        if [ -n "$total_kb" ] && [ -n "$available_kb" ]; then
            # Hitung memori terpakai
            local used_kb=$((total_kb - available_kb))
            
            # Fungsi untuk format human readable (tanpa bc)
            format_bytes_simple() {
                local bytes_kb=$1
                if [ $bytes_kb -ge 1048576 ]; then # 1024*1024 = 1GB in KB
                    local gb_int=$((bytes_kb / 1048576))
                    local gb_frac=$(( (bytes_kb % 1048576) / 10485 )) # approx 0.xx
                    echo "${gb_int}.${gb_frac} GB"
                elif [ $bytes_kb -ge 1024 ]; then # 1MB in KB
                    local mb_int=$((bytes_kb / 1024))
                    local mb_frac=$(( (bytes_kb % 1024) / 10 )) # approx 0.xx
                    echo "${mb_int}.${mb_frac} MB"
                else
                    echo "${bytes_kb} KB"
                fi
            }
            
            # Format total dan used dalam GB/MB
            local total_human=""
            local used_human=""
            
            if [ $total_kb -ge 1048576 ]; then # > 1GB
                total_human="$((total_kb / 1048576)).$(( (total_kb % 1048576) / 10485 )) GB"
                used_human="$((used_kb / 1048576)).$(( (used_kb % 1048576) / 10485 )) GB"
            elif [ $total_kb -ge 1024 ]; then # > 1MB
                total_human="$((total_kb / 1024)).$(( (total_kb % 1024) / 10 )) MB"
                used_human="$((used_kb / 1024)).$(( (used_kb % 1024) / 10 )) MB"
            else
                total_human="${total_kb} KB"
                used_human="${used_kb} KB"
            fi
            
            # Hitung persentase
            local used_percent=0
            if [ "$total_kb" -gt 0 ]; then
                used_percent=$(( (used_kb * 100) / total_kb ))
            fi
            
            echo "üíΩ *Memori Sistem*: ${used_human} / ${total_human} (${used_percent}%)"
        else
            echo "üíΩ *Memori Sistem*: Informasi tidak tersedia"
        fi
    else
        echo "üíΩ *Memori Sistem*: Informasi tidak tersedia"
    fi
}

# Fungsi untuk menampilkan status detail bot di Telegram
show_bot_status() {
    local chat_id="$1"
    local message_id="$2"
    
    # Dapatkan status dari fungsi get_bot_status
    local status_json=$(get_bot_status)
    local status=$(echo "$status_json" | jq -r '.status // empty' 2>/dev/null)
    
    # Jika tidak ada jq, gunakan parsing sederhana
    if [ -z "$status" ]; then
        status=$(echo "$status_json" | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
    fi
    
    if [ "$status" = "running" ]; then
        # Extract data dari JSON dengan default values
        local pid=$(echo "$status_json" | jq -r '.pid // ""' 2>/dev/null || echo "")
        local uptime=$(echo "$status_json" | jq -r '.uptime // ""' 2>/dev/null || echo "")
        local start_time=$(echo "$status_json" | jq -r '.start_time // ""' 2>/dev/null || echo "")
        local memory_usage=$(echo "$status_json" | jq -r '.memory_usage // ""' 2>/dev/null || echo "")
        local memory_percent=$(echo "$status_json" | jq -r '.memory_percent // ""' 2>/dev/null || echo "")
        local location=$(echo "$status_json" | jq -r '.location // ""' 2>/dev/null || echo "")
        local timezone=$(echo "$status_json" | jq -r '.timezone // ""' 2>/dev/null || echo "")
        local source=$(echo "$status_json" | jq -r '.source // ""' 2>/dev/null || echo "")
        local hijri_adjust=$(echo "$status_json" | jq -r '.hijri_adjust // ""' 2>/dev/null || echo "")
        
        # Jika gagal parse dengan jq, coba manual parsing
        if [ -z "$hijri_adjust" ]; then
            hijri_adjust=$(echo "$status_json" | grep -o '"hijri_adjust":"[^"]*"' | cut -d'"' -f4)
        fi
        
        # Jika masih kosong, ambil dari variabel config langsung
        if [ -z "$hijri_adjust" ]; then
            hijri_adjust="$SCHEDULE_HIJRI_ADJUST"
        fi
        
        # Debug logging
        log "DEBUG: hijri_adjust dari JSON: '$hijri_adjust', dari config: '$SCHEDULE_HIJRI_ADJUST'"
        
        # Konversi sumber
        local source_name=""
        case "$source" in
            "jadwalsholat") source_name="JadwalSholat.org" ;;
            "aladhan") source_name="AlAdhan API" ;;
            "myquran") source_name="MyQuran API" ;;
            "apiajimedia") source_name="AjiMedia API" ;;
            *) source_name="$source" ;;
        esac
        
        # Status service
        local service_status=$([ "$SERVICE_ENABLED" = "1" ] && echo "üü¢ AKTIF" || echo "üî¥ NONAKTIF")
        local sound_status=$([ "$SOUND_ENABLED" = "1" ] && echo "üü¢ AKTIF" || echo "üî¥ NONAKTIF")
        local telegram_status=$([ "$SERVICE_TELEGRAM_ENABLED" = "1" ] && echo "üü¢ AKTIF" || echo "üî¥ NONAKTIF")
        local reminder_status="üî¥ NONAKTIF"
        if [ "$SOUND_REMINDER_BEFORE" != "0" ]; then
            reminder_status="üü¢ AKTIF (${SOUND_REMINDER_BEFORE}m)"
        fi
        
        # Format info memori bot
        local memory_info="üíæ *Memori Bot*: ${memory_usage}"
        if [ -n "$memory_percent" ] && [ "$memory_percent" != "0" ]; then
            memory_info+=" (${memory_percent}%)"
        fi
        
        # Dapatkan info memori sistem
        local system_memory_info=$(get_system_memory_info)
        
        # Log info
        local log_info=""
        if [ -f "$LOG_FILE" ]; then
            local log_lines=$(wc -l < "$LOG_FILE" 2>/dev/null || echo "0")
            local log_size=$(du -h "$LOG_FILE" 2>/dev/null | cut -f1 || echo "0B")
            log_info="üìä *Log File*: ${log_lines} baris (${log_size})"
        fi
        
        # Waktu server
        local server_time=$(date +"%Y-%m-%d %H:%M:%S %Z")
        
        # Format pesan
        local status_message=$(printf 'ü§ñ *STATUS BOT JSHOLAT*

üü¢ *STATUS*: BERJALAN
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚îÇ‚è±  *Uptime*: %s
‚îÇüî¢  *PID*: %s
‚îÇ‚è∞  *Start Time*: %s
‚îÇ%s
‚îÇ%s
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

üìç *LOKASI & SUMBER*
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚îÇüèôÔ∏è  *Wilayah*: %s
‚îÇüåê  *Zona Waktu*: %s
‚îÇüì°  *Sumber Jadwal*: %s
‚îÇüìÖ  *Adjust Hijriyah*: %s
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

‚öôÔ∏è *PENGATURAN*
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚îÇüõ†Ô∏è  *Service*: %s
‚îÇüîä  *Suara Adzan*: %s
‚îÇü§ñ  *Notifikasi Telegram*: %s
‚îÇüîî  *Pengingat Sholat*: %s
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

%s
üïí *Waktu Server*: %s
üÜî *Last Update ID*: %s' \
"$uptime" "$pid" "$start_time" "$memory_info" "$system_memory_info" \
"$location" "$timezone" "$source_name" "$hijri_adjust" \
"$service_status" "$sound_status" "$telegram_status" "$reminder_status" \
"$log_info" "$server_time" "$LAST_UPDATE_ID")
        
    else
        # Bot stopped
        local status_message="üî¥ *STATUS BOT JSHOLAT*

‚ùå *STATUS*: BERHENTI

‚ÑπÔ∏è Bot saat ini tidak berjalan.
Gunakan /control untuk mengaktifkannya kembali.

üïí *Waktu Server*: $(date +"%Y-%m-%d %H:%M:%S %Z")"
    fi
    
    # Kirim atau edit pesan
    if [ -z "$message_id" ]; then
        send_message "$chat_id" "$status_message"
    else
        remove_keyboard "$chat_id" "$message_id" "$status_message"
    fi
}

# Fungsi proses pesan
process_message() {
    local chat_id="$1"
    local text="$2"
    
    # Cek authorization
    if ! check_authorization "$chat_id"; then
        send_message "$chat_id" "‚õî This is a private bot. If you want to implement one for you, check this out https://www.ajisetiawan.com/projects/jsholat"
        log "‚õî Percobaan akses dari chat ID tidak terdaftar: $chat_id"
        return
    fi

    log "Menerima pesan dari chat_id=$chat_id: dengan isi $text"

    case "$text" in
        "/start")
            send_message "$chat_id" "Assalamu'alaikum! 

ü§ñ Saya bot jadwal sholat. Gunakan perintah:

/jadwal - Lihat jadwal sholat hari ini
/jdwlbulan - Lihat jadwal sholat bulan ini
/statusbot - Lihat status detail bot
/setjadwal - Ubah sumber jadwal sholat
/sethijri - Atur koreksi tanggal Hijriyah (-2,-1,0,+1,+2)
/lokasi - Lihat wilayah jadwal saat ini
/setlokasi - Ubah lokasi untuk jadwal sholat
/setvolume - Atur volume suara adzan (0-100)
/reminder - Atur durasi pengingat sholat
/control - Kontrol service jsholat
/status - Lihat status pengaturan
/update - Update jadwal sholat terbaru
/help - Tampilkan bantuan ini"
            ;;
		"/jadwal")
			show_daily_schedule "$chat_id"
			;;
       "/jdwlbulan")
            send_monthly_schedule "$chat_id"
            ;;
        "/lokasi")
            local lokasi="$SCHEDULE_CITY_LABEL"
            local provinsi="$SCHEDULE_PROVINCE"
            send_message "$chat_id" "üìç Lokasi jadwal saat ini: *$lokasi, $provinsi*"
            ;;
        "/control")
            show_control_menu "$chat_id"
            ;;
        "/setvolume")
            show_volume_menu "$chat_id"
            ;;
		"/statusbot")
        show_bot_status "$chat_id"
        ;;	
        "/status")
            local city_label="$SCHEDULE_CITY_LABEL"
            local provinsi="$SCHEDULE_PROVINCE"
            local service_status="$SERVICE_ENABLED"
            local sound_status="$SOUND_ENABLED"
            local telegram_status="$SERVICE_TELEGRAM_ENABLED"
            local timezone="$SCHEDULE_TIMEZONE"
            local source="$SCHEDULE_SOURCE"
            local interval="$SCHEDULE_INTERVAL"
			local reminder_status="$SOUND_REMINDER_BEFORE"
            local hijri_adj="$SCHEDULE_HIJRI_ADJUST"  
			

            # Convert status to human-readable format
            service_status=$([ "$service_status" = "1" ] && echo "AKTIF" || echo "NONAKTIF")
            sound_status=$([ "$sound_status" = "1" ] && echo "AKTIF" || echo "NONAKTIF")
            telegram_status=$([ "$telegram_status" = "1" ] && echo "AKTIF" || echo "NONAKTIF")
            
			# Convert reminder status to human-readable format
			if [ "$reminder_status" = "0" ]; then
				reminder_status="NONAKTIF"
			else
				reminder_status="AKTIF (${reminder_status} menit)"
			fi
			
            # Convert source to readable name
            case "$source" in
                "jadwalsholat") source="JadwalSholat.org" ;;
                "aladhan") source="AlAdhan API" ;;
                "myquran") source="MyQuran API" ;;
                "apiajimedia") source="AjiMedia API" ;;
            esac
            
            # Convert interval to readable name
            case "$interval" in
                "0") interval="Tidak Otomatis" ;;
                "3600") interval="Setiap Jam" ;;
                "86400") interval="Setiap Hari" ;;
                "604800") interval="Setiap Minggu" ;;
                "monthly_special") interval="Setiap Bulan" ;;
                *) interval="Tidak diketahui" ;;
            esac
            
            send_message "$chat_id" "üìä *Status Pengaturan Jsholat*

üìç *Wilayah*: $city_label, $provinsi
üïí *Zona Waktu*: $timezone
üîÑ *Pembaruan Jadwal*: $interval
üåê *Sumber Jadwal*: $source
üìÖ *Adjust Hijriyah*: $hijri_adj
üõ† *Status Service*: $service_status
üîä *Suara Adzan*: $sound_status
üì± *Notifikasi Telegram*: $telegram_status
üîî *Pengingat Sholat*: $reminder_status"
            ;;
        "/update")
            # Create confirmation keyboard
            local keyboard='[[
                {"text": "‚úÖ Ya, Update Jadwal", "callback_data": "confirm_update"},
                {"text": "‚ùå Batal", "callback_data": "cancel_update"}
            ]]'
            
            local update_message=$(printf '‚ö†Ô∏è *Update Jadwal Sholat*\n\nAnda yakin ingin mengupdate jadwal sholat?\n\nProses ini akan menjalankan update dan mungkin memakan waktu beberapa detik.')
			send_inline_keyboard "$chat_id" "$update_message" "$keyboard"
            ;;
        "/setjadwal")
            show_source_menu "$chat_id"
            ;;
		"/reminder")
			show_reminder_menu "$chat_id"
			;;	
        "/setlokasi")
            mkdir -p "$LOCATION_SEARCH_FLAG_DIR"
            touch "$LOCATION_SEARCH_FLAG_DIR/${chat_id}.flag"
            send_message "$chat_id" "$(printf 'üîç Masukkan nama kota/kabupaten yang ingin dicari:\nContoh: *%s* atau *%s*' "Bandung" "Aceh Barat")"
            ;;
        "/help")
            send_help_message "$chat_id"
            ;;
        "/sethijri")
            show_hijri_adjust_menu "$chat_id"
            ;;    
        *)
            if [ -f "$LOCATION_SEARCH_FLAG_DIR/${chat_id}.flag" ]; then
                rm -f "$LOCATION_SEARCH_FLAG_DIR/${chat_id}.flag"
                show_location_results "$chat_id" "" "$text"
            else
                send_message "$chat_id" "Perintah tidak dikenali. Gunakan /start untuk melihat menu"
                send_help_message "$chat_id"
            fi
            ;;
    esac
}

# Fungsi proses callback query (tanpa logging response)
process_callback() {
    local callback_id="$1"
    local chat_id="$2"
    local message_id="$3"
    local data="$4"
    
    # Cek authorization
    if ! check_authorization "$chat_id"; then
        curl -s -X POST \
            "https://api.telegram.org/bot${TELEGRAM_TOKEN}/answerCallbackQuery" \
            -d callback_query_id="${callback_id}" \
            -d text="‚õî This is a private bot" \
            -d show_alert="true" \
            > /dev/null 2>&1
        log "Percobaan akses callback dari chat ID tidak terdaftar: $chat_id"    
        return
    fi

    [ "$DEBUG_MODE" = "1" ] && log "Memproses callback: $data dari chat_id=$chat_id"

    # Jawab callback query
    curl -s -X POST \
        "https://api.telegram.org/bot${TELEGRAM_TOKEN}/answerCallbackQuery" \
        -d callback_query_id="${callback_id}" \
        > /dev/null 2>&1

    case "$data" in
        "on")
            update_service_status "$chat_id" "$message_id" "1"
            ;;
        "off")
            update_service_status "$chat_id" "$message_id" "0"
            ;;
        "done")
            remove_keyboard "$chat_id" "$message_id" "üõ† Kontrol service selesai"
            ;;
		"bot_status")
        show_bot_status "$chat_id" "$message_id"
        ;;	
        "status")
            local current_status="$SERVICE_ENABLED"
            local status_text=$([ "$current_status" = "1" ] && echo "AKTIF" || echo "NONAKTIF")
            
            curl -s -X POST \
                "https://api.telegram.org/bot${TELEGRAM_TOKEN}/answerCallbackQuery" \
                -d callback_query_id="${callback_id}" \
                -d text="Status saat ini: $status_text" \
                -d show_alert="false" \
                > /dev/null 2>&1
            ;;
        "settings")
            show_settings_menu "$chat_id" "$message_id"
            ;;
        set_volume_*)
            local volume_level=$(echo "$data" | cut -d'_' -f3)
            set_volume "$chat_id" "$message_id" "$volume_level"
            ;;
        "test_volume")
            test_volume "$chat_id" "$message_id"
            ;;
        "volume_menu")
            show_volume_menu "$chat_id" "$message_id"
            ;;    
        "toggle_sound")
            toggle_sound_setting "$chat_id" "$message_id"
            ;;
        "toggle_telegram")
            toggle_telegram_setting "$chat_id" "$message_id"
            ;;
        "back_to_control")
            show_control_menu "$chat_id" "$message_id"
            ;;
		"back_to_volume")
			show_volume_menu "$chat_id" "$message_id"
			;;	
        "set_source_jadwalsholat")
            set_jadwal_source "$chat_id" "$message_id" "jadwalsholat"
            ;;
        "set_source_aladhan")
            set_jadwal_source "$chat_id" "$message_id" "aladhan"
            ;;
        "set_source_myquran")
            set_jadwal_source "$chat_id" "$message_id" "myquran"
            ;;
        "set_source_apiajimedia")
            set_jadwal_source "$chat_id" "$message_id" "apiajimedia"
            ;;
        "confirm_update")
            # Hapus pesan konfirmasi
            curl -s -X POST \
                "https://api.telegram.org/bot${TELEGRAM_TOKEN}/deleteMessage" \
                -d chat_id="${chat_id}" \
                -d message_id="${message_id}" \
                > /dev/null 2>&1

            # Pesan progress awal
            local progress_msg=$(curl -s -X POST \
                "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
                -d chat_id="${chat_id}" \
                -d text="üîÑ Memulai update jadwal sholat..." \
                -d parse_mode="Markdown")
            
            local progress_msg_id=$(echo "$progress_msg" | jq -r '.result.message_id')
            
            # Function untuk update progress
            update_progress() {
                local text="$1"
                curl -s -X POST \
                    "https://api.telegram.org/bot${TELEGRAM_TOKEN}/editMessageText" \
                    -d chat_id="${chat_id}" \
                    -d message_id="${progress_msg_id}" \
                    -d text="$text" \
                    -d parse_mode="Markdown" \
                    > /dev/null 2>&1
                sleep 0.3
            }
            
            # Simpan output ke temporary file
            local tmp_file=$(mktemp)
            /usr/bin/jadwal-update.sh 2>&1 | tee "$tmp_file"
            
            # Proses output untuk ditampilkan (dengan pembersihan timestamp yang lebih baik)
            while IFS= read -r line; do
                # Pembersihan timestamp yang lebih kuat
                clean_line=$(echo "$line" | sed -E 's/^[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2} //')
                # 2. Untuk format lain jika ada
                clean_line=$(echo "$clean_line" | sed -E 's/^\[[0-9-]+ [0-9:]+\] //')
                update_progress "$clean_line"
            done < "$tmp_file"
            
            # Cek error dan format pesan dengan benar
            local update_failed=0
            local output_chat=""
            
            if grep -qi "error" "$tmp_file"; then
                update_failed=1
                # Ambil error terakhir dan bersihkan timestamp dengan lebih teliti
                local last_error=$(grep -i "error" "$tmp_file" | tail -1)
                # Dua versi pembersihan timestamp:
                # 1. Untuk format default: "2025-04-18 06:34:41 Error..."
                last_error=$(echo "$last_error" | sed -E 's/^[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2} //')
                # 2. Untuk format lain jika ada
                last_error=$(echo "$last_error" | sed -E 's/^\[[0-9-]+ [0-9:]+\] //')
                
                output_chat=$(printf "‚ùå Gagal memperbarui jadwal\n\nPesan error: %s\n\nSilakan coba lagi atau periksa log sistem." "$last_error")
            else
                output_chat="‚úÖ Jadwal sholat berhasil diperbarui"
            fi
            
            # Tampilkan hasil akhir
            update_progress "$formatted_error"
            
            # Bersihkan
            rm -f "$tmp_file"
            remove_keyboard "$chat_id" "$message_id" " "
            ;;
        "cancel_update")
            remove_keyboard "$chat_id" "$message_id" "‚ùå Update dibatalkan"
            log "‚ùå  Update dibatalkan.."
            ;;
        set_location_*)
            # Handle location selection
            local city_value=$(echo "$data" | cut -d'_' -f3)
            local timezone=$(echo "$data" | cut -d'_' -f4)
            set_location "$chat_id" "$message_id" "$city_value" "$timezone"
            ;;
		"reminder_menu")
			show_reminder_menu "$chat_id" "$message_id"
			;;
		set_reminder_*)
			local duration=$(echo "$data" | cut -d'_' -f3)
			set_reminder_duration "$chat_id" "$message_id" "$duration"
			;;
		"hijri_menu")
            show_hijri_adjust_menu "$chat_id" "$message_id"
            ;;
        set_hijri_adj_*)
            # Parse nilai dengan benar
            local adj_value=$(echo "$data" | sed 's/set_hijri_adj_//')
            set_hijri_adjust "$chat_id" "$message_id" "$adj_value"
            ;;
    esac
}

# Main loop dengan error handling
while true; do
    # Ambil updates dari Telegram API
    response=$(curl -s -w "\n%{http_code}" "https://api.telegram.org/bot${TELEGRAM_TOKEN}/getUpdates?offset=$((LAST_UPDATE_ID + 1))&timeout=10" 2>&1)
    
    if [ $? -ne 0 ]; then
        log "Error saat menghubungi Telegram API: $response"
        sleep 5
        continue
    fi
    
    http_code=$(echo "$response" | tail -n1)
    updates=$(echo "$response" | sed '$d')
    
    if [ "$http_code" -ne 200 ]; then
        log "Error HTTP dari Telegram API. Code: $http_code"
        [ "$DEBUG_MODE" = "1" ] && log "Response: $updates"
        sleep 5
        continue
    fi

    # Parse update IDs
    update_ids=$(echo "$updates" | jq -r '.result[].update_id' 2>/dev/null)
    
    if [ -z "$update_ids" ]; then
        sleep 1
        continue
    fi

    # Proses setiap update
    for update_id in $update_ids; do
        if [ "$update_id" -gt "$LAST_UPDATE_ID" ]; then
            # Ekstrak data update
            update=$(echo "$updates" | jq -r --argjson id "$update_id" '.result[] | select(.update_id == $id)')
            
            # Cek apakah ini message
            message=$(echo "$update" | jq -r '.message // empty')
            if [ -n "$message" ]; then
                chat_id=$(echo "$message" | jq -r '.chat.id')
                text=$(echo "$message" | jq -r '.text // empty')
                
                if [ -n "$chat_id" ] && [ -n "$text" ]; then
                    process_message "$chat_id" "$text"
                fi
            fi
            
            # Cek apakah ini callback query
            callback_query=$(echo "$update" | jq -r '.callback_query // empty')
            if [ -n "$callback_query" ]; then
                callback_id=$(echo "$callback_query" | jq -r '.id // empty')
                callback_chat_id=$(echo "$callback_query" | jq -r '.message.chat.id // empty')
                callback_message_id=$(echo "$callback_query" | jq -r '.message.message_id // empty')
                callback_data=$(echo "$callback_query" | jq -r '.data // empty')
                
                if [ -n "$callback_id" ] && [ -n "$callback_data" ] && [ -n "$callback_chat_id" ] && [ -n "$callback_message_id" ]; then
                    process_callback "$callback_id" "$callback_chat_id" "$callback_message_id" "$callback_data"
                fi
            fi
            
            LAST_UPDATE_ID=$update_id
			write_last_update_id "$LAST_UPDATE_ID"  # Simpan ke file
        fi
    done

    sleep 0.5
done