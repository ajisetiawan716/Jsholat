#!/bin/sh

# =============================================
# JSHOLAT SERVICE SCRIPT v1.7.8 
# Penjadwal dan Pemutar Adzan Otomatis
# (C) 2025 Jsholat - @ajisetiawan716
# Original script by Mikodemos
# Rewrited by Aji Setiawan
# =============================================

# Konfigurasi Logging
LOG_DIR="/var/log/jsholat"
LOG_FILE="$LOG_DIR/service.log"
MAX_LOG_SIZE=1048576  # 1MB
DEBUG_MODE=$(uci -q get jsholat.service.debug_mode || echo "0")

# Fungsi untuk info Hijriyah
HIJRI_CACHE_FILE="/tmp/jsholat_cache/hijri_date_cache.json"
HIJRI_CACHE_EXPIRE=3600 # Cache berlaku selama 1 jam (3600 detik)

# Fungsi untuk mendapatkan tanggal Hijriyah dengan cache
# Fungsi untuk mendapatkan tanggal Hijriyah dengan cache
get_hijri_date() {
    local gregorian_date=$(date +"%Y-%m-%d")
    local now=$(date +%s)
    
    # Baca nilai adjustment dari config UCI, default -1
    local hijri_adj=$(uci -q get jsholat.schedule.hijri_adjust || echo "-1")
    
    # Cek cache terlebih dahulu
    if [ -f "$HIJRI_CACHE_FILE" ]; then
        local cache_time=$(jq -r '.cache_time' "$HIJRI_CACHE_FILE" 2>/dev/null)
        local cached_date=$(jq -r '.hijri_date' "$HIJRI_CACHE_FILE" 2>/dev/null)
        
        if [ -n "$cache_time" ] && [ -n "$cached_date" ] && 
           [ $((now - cache_time)) -lt $HIJRI_CACHE_EXPIRE ]; then
            echo "$cached_date"
            return 0
        fi
    fi
    
    # Jika cache tidak ada atau sudah expired, ambil dari API
    local api_url="https://api.myquran.com/v2/cal/hijr/$gregorian_date?adj=$hijri_adj"
    local response=$(curl -s --max-time 5 "$api_url") # Timeout 5 detik
    local status=$(echo "$response" | jq -r '.status' 2>/dev/null)
    
    if [ "$status" = "true" ]; then
        local hijri_date=$(echo "$response" | jq -r '.data.date[1]' 2>/dev/null)
        
        # Simpan ke cache
        mkdir -p "/tmp/jsholat_cache"
        echo "{\"cache_time\":$now,\"hijri_date\":\"$hijri_date\"}" > "$HIJRI_CACHE_FILE"
        echo "$hijri_date"
        return 0
    else
        log "ERROR" "‚ùå Gagal mendapatkan tanggal Hijriyah dari API"
        # Coba gunakan cache yang expired jika ada
        if [ -n "$cached_date" ]; then
            echo "$cached_date"
            return 1
        else
            echo ""
            return 1
        fi
    fi
}

# File untuk menyimpan status reminder
REMINDER_STATUS_FILE="/var/lib/jsholat/reminder_status"

# Fungsi untuk menyimpan status reminder ke file
save_reminder_status() {
    local status_dir=$(dirname "$REMINDER_STATUS_FILE")
    [ -d "$status_dir" ] || mkdir -p "$status_dir"
    
    echo "REMINDER_IMSYAK=$REMINDER_IMSYAK" > "$REMINDER_STATUS_FILE"
    echo "REMINDER_SUBUH=$REMINDER_SUBUH" >> "$REMINDER_STATUS_FILE"
    echo "REMINDER_DZUHUR=$REMINDER_DZUHUR" >> "$REMINDER_STATUS_FILE"
    echo "REMINDER_ASHAR=$REMINDER_ASHAR" >> "$REMINDER_STATUS_FILE"
    echo "REMINDER_MAGHRIB=$REMINDER_MAGHRIB" >> "$REMINDER_STATUS_FILE"
    echo "REMINDER_ISYA=$REMINDER_ISYA" >> "$REMINDER_STATUS_FILE"
    
    [ "$DEBUG_MODE" = "1" ] && log "DEBUG" "üíæ Status reminder disimpan"
}

# Fungsi untuk membaca status reminder dari file
load_reminder_status() {
    local REMINDER_BEFORE=$(uci -q get jsholat.sound.reminder_before || echo "5")
    
    # ‚úÖ JIKA REMINDER DINONAKTIFKAN, SKIP LOAD
    if [ "$REMINDER_BEFORE" = "0" ]; then
        [ "$DEBUG_MODE" = "1" ] && log "DEBUG" "üîï Skip load reminder status (fitur dinonaktifkan)"
        return
    fi
    
    if [ -f "$REMINDER_STATUS_FILE" ]; then
        # Source file untuk load variabel
        . "$REMINDER_STATUS_FILE"
        [ "$DEBUG_MODE" = "1" ] && log "DEBUG" "üìñ Status reminder dimuat dari file"
    else
        [ "$DEBUG_MODE" = "1" ] && log "DEBUG" "üìñ File status reminder tidak ditemukan, menggunakan default"
    fi
}

# Fungsi untuk reset reminder setiap hari baru
reset_reminder_status() {
    local TODAY=$(date +"%d-%m-%Y")
    local LAST_RESET_DATE=""
    local REMINDER_BEFORE=$(uci -q get jsholat.sound.reminder_before || echo "5")
    
    # ‚úÖ JIKA REMINDER DINONAKTIFKAN, SKIP RESET
    if [ "$REMINDER_BEFORE" = "0" ]; then
        [ "$DEBUG_MODE" = "1" ] && log "DEBUG" "üîï Skip reset reminder (fitur dinonaktifkan)"
        return
    fi
    
    # Cek file last reset date jika ada
    if [ -f "/var/lib/jsholat/last_reset_date" ]; then
        LAST_RESET_DATE=$(cat "/var/lib/jsholat/last_reset_date")
    fi
    
    # Reset hanya jika hari berbeda
    if [ "$LAST_RESET_DATE" != "$TODAY" ]; then
        REMINDER_IMSYAK=0
        REMINDER_SUBUH=0
        REMINDER_DZUHUR=0
        REMINDER_ASHAR=0
        REMINDER_MAGHRIB=0
        REMINDER_ISYA=0
        
        # Simpan tanggal reset terakhir
        echo "$TODAY" > "/var/lib/jsholat/last_reset_date"
        save_reminder_status
        
        log "INFO" "üîÑ Status reminder direset untuk hari baru: $TODAY"
    fi
}

# Fungsi alternatif dengan presisi lebih tinggi
get_system_memory_info() {
    if [ -f "/proc/meminfo" ]; then
        local total_kb=$(grep -E '^MemTotal:' /proc/meminfo 2>/dev/null | awk '{print $2}')
        local available_kb=$(grep -E '^MemAvailable:' /proc/meminfo 2>/dev/null | awk '{print $2}')
        
        if [ -n "$total_kb" ] && [ -n "$available_kb" ]; then
            local used_kb=$((total_kb - available_kb))
            local used_percent=0
            [ "$total_kb" -gt 0 ] && used_percent=$(( (used_kb * 100) / total_kb ))
            
            # Format used dalam MB (selalu)
            local used_mb_int=$((used_kb / 1024))
            local used_kb_remainder=$((used_kb % 1024))
            # Hitung fraksi MB (2 digit desimal)
            local used_mb_frac=$(( (used_kb_remainder * 100) / 1024 ))
            # Pastikan selalu 2 digit
            [ ${#used_mb_frac} -eq 1 ] && used_mb_frac="0${used_mb_frac}"
            
            # Format total: GB jika >= 1GB, MB jika < 1GB
            if [ $total_kb -ge 1048576 ]; then # >= 1GB
                local total_gb_int=$((total_kb / 1048576))
                local total_remainder_kb=$((total_kb % 1048576))
                local total_mb_remainder=$((total_remainder_kb / 1024))
                # Hitung fraksi GB (2 digit desimal)
                local total_gb_frac=$(( (total_mb_remainder * 100) / 1024 ))
                [ ${#total_gb_frac} -eq 1 ] && total_gb_frac="0${total_gb_frac}"
                
                echo "${used_mb_int}.${used_mb_frac} MB / ${total_gb_int}.${total_gb_frac} GB (${used_percent}%)"
            else
                local total_mb_int=$((total_kb / 1024))
                local total_kb_remainder=$((total_kb % 1024))
                local total_mb_frac=$(( (total_kb_remainder * 100) / 1024 ))
                [ ${#total_mb_frac} -eq 1 ] && total_mb_frac="0${total_mb_frac}"
                
                echo "${used_mb_int}.${used_mb_frac} MB / ${total_mb_int}.${total_mb_frac} MB (${used_percent}%)"
            fi
        else
            echo "Information not available"
        fi
    else
        echo "Information not available"
    fi
}

# FUNGSI BARU: TAMPILKAN STATUS SERVICE DENGAN UPTIME
show_status() {
    echo "============================================="
    echo "          STATUS SERVICE JSHOLAT"
    echo "============================================="
    
    # Cek apakah service berjalan
    local pid=$(pgrep -f "/usr/bin/jsholat run")
    if [ -n "$pid" ]; then
        echo "‚úÖ Service: BERJALAN (PID: $pid)"
        
        # Cek apakah proses benar-benar berjalan
        if kill -0 "$pid" 2>/dev/null; then
            echo "   Proses: /usr/bin/jsholat run"
            
            # HITUNG UPTIME PROSES
            if [ -d "/proc/$pid" ]; then
                # Cara 1: Menggunakan /proc filesystem
                local start_time=$(stat -c %Y "/proc/$pid" 2>/dev/null)
                if [ -n "$start_time" ]; then
                    local now=$(date +%s)
                    local uptime_seconds=$((now - start_time))
                    
                    # Konversi ke format yang mudah dibaca
                    local days=$((uptime_seconds / 86400))
                    local hours=$(( (uptime_seconds % 86400) / 3600 ))
                    local minutes=$(( (uptime_seconds % 3600) / 60 ))
                    local seconds=$((uptime_seconds % 60))
                    
                    if [ $days -gt 0 ]; then
                        echo "   Uptime: ${days} hari ${hours} jam ${minutes} menit"
                    elif [ $hours -gt 0 ]; then
                        echo "   Uptime: ${hours} jam ${minutes} menit"
                    elif [ $minutes -gt 0 ]; then
                        echo "   Uptime: ${minutes} menit ${seconds} detik"
                    else
                        echo "   Uptime: ${seconds} detik"
                    fi
                    
                    # Hitung waktu mulai
                    local start_date=$(date -d "@$start_time" "+%Y-%m-%d %H:%M:%S" 2>/dev/null || \
                                       date "+%Y-%m-%d %H:%M:%S" -d "@$start_time" 2>/dev/null || \
                                       echo "Tidak diketahui")
                    echo "   Mulai:  $start_date"
                fi
            else
                # Cara 2: Menggunakan ps (jika /proc tidak tersedia)
                local ps_output=$(ps -o etime= -p "$pid" 2>/dev/null || \
                                  ps -o etime= "$pid" 2>/dev/null || \
                                  echo "00:00")
                echo "   Uptime: $ps_output"
            fi
            
            # Cek penggunaan memory (jika tersedia)
            if [ -f "/proc/$pid/status" ]; then
                local memory_kb=$(grep VmRSS "/proc/$pid/status" 2>/dev/null | awk '{print $2}')
                if [ -n "$memory_kb" ]; then
                    local memory_mb=$((memory_kb / 1024))
                    echo "   Memory: ${memory_mb} MB (${memory_kb} KB)"
                fi
            fi
            
        else
            echo "   ‚ö†Ô∏è  Proses PID $pid ditemukan tetapi tidak merespon"
        fi
    else
        echo "‚ùå Service: TIDAK BERJALAN"
        
        # Cek apakah pernah berjalan dengan melihat log terakhir
        if [ -f "/var/log/jsholat/service.log" ]; then
            local last_start=$(grep "SERVICE JSHOLAT DIMULAI" "/var/log/jsholat/service.log" 2>/dev/null | tail -1)
            if [ -n "$last_start" ]; then
                echo "   Terakhir berjalan: $(echo "$last_start" | cut -d' ' -f1-3)"
            fi
        fi
    fi
    
    # Cek konfigurasi service
    local service_enabled=$(uci -q get jsholat.service.service || echo "1")
    echo "‚öôÔ∏è  Status Konfigurasi: $([ "$service_enabled" = "1" ] && echo "AKTIF" || echo "NONAKTIF")"
    
    # Cek status reminder
    if [ -f "/var/lib/jsholat/last_reset_date" ]; then
        echo "üìÖ Reset Terakhir: $(cat /var/lib/jsholat/last_reset_date)"
    fi
    
    # Tampilkan file log
    if [ -f "/var/log/jsholat/service.log" ]; then
        local log_size=$(du -h "/var/log/jsholat/service.log" 2>/dev/null | awk '{print $1}')
        local log_lines=$(wc -l < "/var/log/jsholat/service.log" 2>/dev/null || echo "0")
        echo "üìä Log File: /var/log/jsholat/service.log"
        echo "   Ukuran: ${log_size:-Tidak diketahui}, Baris: $log_lines"
        
        # Tampilkan 5 baris terakhir log
        echo "   --- 5 Baris Terakhir Log ---"
        tail -5 "/var/log/jsholat/service.log" 2>/dev/null | while read -r line; do
            echo "   $line"
        done
    else
        echo "üìä Log File: Tidak ditemukan"
    fi
    
    # Tampilkan konfigurasi fitur
    echo ""
    echo "============================================="
    echo "üîß KONFIGURASI FITUR:"
    
    local telegram_enabled=$(uci -q get jsholat.service.telegram_enabled || echo "1")
    local sound_enabled=$(uci -q get jsholat.sound.sound_enabled || echo "1")
    local ayat_enabled=$(uci -q get jsholat.service.ayat_enabled || echo "1")
    local reminder_before=$(uci -q get jsholat.sound.reminder_before || echo "5")
    local debug_mode=$(uci -q get jsholat.service.debug_mode || echo "0")
    local volume_level=$(uci -q get jsholat.sound.volume_level || echo "80")
    
    echo "   ‚Ä¢ Telegram Notifikasi: $([ "$telegram_enabled" = "1" ] && echo "AKTIF" || echo "NONAKTIF")"
    echo "   ‚Ä¢ Pemutar Suara: $([ "$sound_enabled" = "1" ] && echo "AKTIF" || echo "NONAKTIF")"
    echo "   ‚Ä¢ Volume: ${volume_level}%"
    echo "   ‚Ä¢ Ayat Acak: $([ "$ayat_enabled" = "1" ] && echo "AKTIF" || echo "NONAKTIF")"
    echo "   ‚Ä¢ Reminder Sholat: $([ "$reminder_before" = "0" ] && echo "NONAKTIF" || echo "AKTIF (${reminder_before} menit)")"
    echo "   ‚Ä¢ Debug Mode: $([ "$debug_mode" = "1" ] && echo "AKTIF" || echo "NONAKTIF")"
    
    # Tampilkan jadwal hari ini
    local TODAY=$(date +"%d-%m-%Y")
    local JADWAL=$(uci get jsholat.schedule.file_jadwal 2>/dev/null)
    local LOKASI=$(uci get jsholat.schedule.city_label 2>/dev/null || echo "Tidak Diketahui")
    local TIMEZONE=$(uci -q get jsholat.schedule.timezone_value || echo "")
    local PROVINCE=$(uci get jsholat.schedule.province 2>/dev/null || echo "Tidak Diketahui")
    
    echo ""
    echo "============================================="
    echo "üïå JADWAL SHOLAT HARI INI ($TODAY):"
    echo "   Lokasi: $LOKASI, $PROVINCE"
    
    if [ -f "$JADWAL" ] && [ -r "$JADWAL" ]; then
        local JADWAL_LINE=$(grep "^$TODAY" "$JADWAL" 2>/dev/null | tr -d '\r')
        if [ -n "$JADWAL_LINE" ]; then
            IMSYAK=$(echo "$JADWAL_LINE" | awk '{print $2}' | tr -d '\r')
            SHUBUH=$(echo "$JADWAL_LINE" | awk '{print $3}' | tr -d '\r')
            DZUHUR=$(echo "$JADWAL_LINE" | awk '{print $4}' | tr -d '\r')
            ASHAR=$(echo "$JADWAL_LINE" | awk '{print $5}' | tr -d '\r')
            MAGHRIB=$(echo "$JADWAL_LINE" | awk '{print $6}' | tr -d '\r')
            ISYA=$(echo "$JADWAL_LINE" | awk '{print $7}' | tr -d '\r')
            
            echo "   ‚Ä¢ Imsyak:   $IMSYAK $TIMEZONE"
            echo "   ‚Ä¢ Subuh:    $SHUBUH $TIMEZONE"
            echo "   ‚Ä¢ Dzuhur:   $DZUHUR $TIMEZONE"
            echo "   ‚Ä¢ Ashar:    $ASHAR $TIMEZONE"
            echo "   ‚Ä¢ Maghrib:  $MAGHRIB $TIMEZONE"
            echo "   ‚Ä¢ Isya:     $ISYA $TIMEZONE"
            
            # Waktu sekarang dan status sholat
            local NOW=$(date +"%H:%M")
            echo ""
			echo "============================================="
            echo "‚è∞ WAKTU SEKARANG: $NOW $TIMEZONE"
            
            # Fungsi untuk menampilkan status waktu sholat
            show_prayer_status() {
                local name="$1"
                local time="$2"
                local current_time="$3"
                
                # Konversi waktu ke menit
                local prayer_hours=${time%:*}
                local prayer_minutes=${time#*:}
                prayer_hours=${prayer_hours#0}
                prayer_minutes=${prayer_minutes#0}
                local prayer_total_minutes=$((prayer_hours * 60 + prayer_minutes))
                
                local current_hours=${current_time%:*}
                local current_minutes=${current_time#*:}
                current_hours=${current_hours#0}
                current_minutes=${current_minutes#0}
                local current_total_minutes=$((current_hours * 60 + current_minutes))
                
                local diff=$((prayer_total_minutes - current_total_minutes))
                
                if [ $diff -eq 0 ]; then
                    echo "   üïå $name ($time): SAAT INI!"
                elif [ $diff -gt 0 ]; then
                    if [ $diff -le 5 ]; then
                        echo "   üîî $name ($time): Dalam $diff menit"
                    elif [ $diff -le 30 ]; then
                        echo "   ‚è≥ $name ($time): ${diff} menit lagi"
                    else
                        local hours_remaining=$((diff / 60))
                        local minutes_remaining=$((diff % 60))
                        if [ $hours_remaining -gt 0 ]; then
                            echo "   ‚óã $name ($time): ${hours_remaining} jam ${minutes_remaining} menit lagi"
                        else
                            echo "   ‚óã $name ($time): ${minutes_remaining} menit lagi"
                        fi
                    fi
                else
                    echo "   ‚úì $name ($time): Sudah lewat"
                fi
            }
            
            echo "   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
            echo "   STATUS WAKTU SHOLAT:"
            show_prayer_status "Imsyak" "$IMSYAK" "$NOW"
            show_prayer_status "Subuh" "$SHUBUH" "$NOW"
            show_prayer_status "Dzuhur" "$DZUHUR" "$NOW"
            show_prayer_status "Ashar" "$ASHAR" "$NOW"
            show_prayer_status "Maghrib" "$MAGHRIB" "$NOW"
            show_prayer_status "Isya" "$ISYA" "$NOW"
            
        else
            echo "   ‚ùå Jadwal untuk hari ini tidak ditemukan"
        fi
    else
        echo "   ‚ùå File jadwal tidak ditemukan atau tidak dapat dibaca"
    fi
    
    # Tampilkan informasi sistem
    echo ""
    echo "============================================="
    echo "üíª INFORMASI SISTEM:"
    echo "   Waktu Sistem: $(date '+%Y-%m-%d %H:%M:%S')"
    
    # FORMAT UPTIME YANG KONSISTEN DENGAN /proc/uptime
    if [ -f "/proc/uptime" ]; then
        local uptime_seconds=$(awk '{print int($1)}' /proc/uptime 2>/dev/null)
        if [ -n "$uptime_seconds" ] && [ "$uptime_seconds" -gt 0 ]; then
            local days=$((uptime_seconds / 86400))
            local hours=$(( (uptime_seconds % 86400) / 3600 ))
            local minutes=$(( (uptime_seconds % 3600) / 60 ))
            
            local uptime_str=""
            if [ $days -gt 0 ]; then
                uptime_str="${days} hari"
                if [ $hours -gt 0 ]; then
                    uptime_str="${uptime_str} ${hours} jam"
                fi
                if [ $minutes -gt 0 ]; then
                    uptime_str="${uptime_str} ${minutes} menit"
                fi
            elif [ $hours -gt 0 ]; then
                uptime_str="${hours} jam"
                if [ $minutes -gt 0 ]; then
                    uptime_str="${uptime_str} ${minutes} menit"
                fi
            elif [ $minutes -gt 0 ]; then
                uptime_str="${minutes} menit"
            else
                uptime_str="Kurang dari 1 menit"
            fi
            
            echo "   Uptime Sistem: $uptime_str"
        fi
    else
        # Fallback ke uptime command
        local uptime_output=$(uptime 2>/dev/null | sed 's/.*up //' | sed 's/,.*load.*//')
        if [ -n "$uptime_output" ]; then
            echo "   Uptime Sistem: $uptime_output"
        fi
    fi
    
    # Load Average
    local load_avg=$(uptime 2>/dev/null | grep -o 'load average: .*' || echo "load average: Tidak tersedia")
    echo "   Load Average: $load_avg"
    
    # Informasi memori sistem
    if [ -f "/proc/meminfo" ]; then
        local total_mem=$(grep MemTotal /proc/meminfo | awk '{print $2}')
        local free_mem=$(grep MemFree /proc/meminfo | awk '{print $2}')
        local available_mem=$(grep MemAvailable /proc/meminfo | awk '{print $2}')
        
        if [ -n "$total_mem" ] && [ -n "$available_mem" ]; then
            local total_mb=$((total_mem / 1024))
            local available_mb=$((available_mem / 1024))
            local used_mb=$((total_mb - available_mb))
            local usage_percent=$((used_mb * 100 / total_mb))
            
            echo "   Memory: ${used_mb}MB/${total_mb}MB digunakan (${usage_percent}%)"
        fi
    fi
    
    echo "============================================="
    
    # Return code untuk init script
    if [ -n "$pid" ] && kill -0 "$pid" 2>/dev/null; then
        return 0  # Service berjalan
    else
        return 1  # Service tidak berjalan
    fi
}

# Fungsi untuk mendapatkan status jsholat-bot berdasarkan file PID
get_jsholat_bot_status() {
    local pid_file="/var/run/jsholat-bot.pid"
    
    # Cek file PID terlebih dahulu
    local bot_pid=""
    if [ -f "$pid_file" ] && [ -r "$pid_file" ]; then
        bot_pid=$(cat "$pid_file" 2>/dev/null)
        
        # Validasi PID dari file
        if [ -n "$bot_pid" ] && kill -0 "$bot_pid" 2>/dev/null; then
            echo "running:$bot_pid"
            return 0
        else
            # File PID ada tapi proses sudah mati, hapus file
            rm -f "$pid_file" 2>/dev/null
        fi
    fi
    
    # Fallback: Cari PID dari proses
    bot_pid=$(pgrep -f "/usr/bin/jsholat-bot" | head -1)
    
    if [ -n "$bot_pid" ] && kill -0 "$bot_pid" 2>/dev/null; then
        # Simpan PID ke file untuk penggunaan berikutnya
        echo "$bot_pid" > "$pid_file" 2>/dev/null
        echo "running:$bot_pid"
    else
        echo "stopped"
    fi
    
    return 0
}

# TAMBAHKAN FUNGSI INFO (UNTUK LUCIDAN OUTPUT JSON)
info_service() {
    # Dapatkan status service terlebih dahulu
    local pid
    pid=$(pgrep -f "/usr/bin/jsholat run")
    local service_enabled
    service_enabled=$(uci -q get jsholat.service.service || echo "1")
    local service_running="0"
    
    if [ -n "$pid" ] && kill -0 "$pid" 2>/dev/null; then
        service_running="1"
    fi
    
    # Hitung uptime jika service berjalan
    local uptime_seconds="0"
    local start_time_str=""
    if [ "$service_running" = "1" ] && [ -d "/proc/$pid" ]; then
        local start_time
        start_time=$(stat -c %Y "/proc/$pid" 2>/dev/null)
        if [ -n "$start_time" ]; then
            local now
            now=$(date +%s)
            uptime_seconds=$((now - start_time))
            start_time_str=$(date -d "@$start_time" "+%Y-%m-%d %H:%M:%S" 2>/dev/null || echo "Unknown")
        fi
    fi
    
    # Dapatkan konfigurasi
    local telegram_enabled
    telegram_enabled=$(uci -q get jsholat.service.telegram_enabled || echo "1")
    local sound_enabled
    sound_enabled=$(uci -q get jsholat.sound.sound_enabled || echo "1")
    local ayat_enabled
    ayat_enabled=$(uci -q get jsholat.service.ayat_enabled || echo "1")
    local reminder_before
    reminder_before=$(uci -q get jsholat.sound.reminder_before || echo "5")
    local volume_level
    volume_level=$(uci -q get jsholat.sound.volume_level || echo "80")
    local debug_mode
    debug_mode=$(uci -q get jsholat.service.debug_mode || echo "0")
    
    # TAMBAHKAN: Dapatkan informasi sumber jadwal
    local schedule_source
    schedule_source=$(uci -q get jsholat.schedule.source || echo "unknown")
    local schedule_file
    schedule_file=$(uci -q get jsholat.schedule.file_jadwal || echo "")
    
    # Konversi sumber
    local source_alias=""
    case "$schedule_source" in
        "jadwalsholat") source_alias="JadwalSholat.org" ;;
        "aladhan") source_alias="AlAdhan API" ;;
        "myquran") source_alias="MyQuran API" ;;
        "apiajimedia") source_alias="AjiMedia API" ;;
    esac
    
    # Dapatkan info last update jadwal
    local last_updated="Tidak diketahui"
    local last_updated_file="/usr/share/jsholat/last_updated.txt"
    
    if [ -f "$last_updated_file" ] && [ -r "$last_updated_file" ]; then
        if command -v jq >/dev/null 2>&1; then
            local extracted_date=$(jq -r '.last_updated // ""' "$last_updated_file" 2>/dev/null)
            
            if [ -n "$extracted_date" ] && [ "$extracted_date" != "null" ] && [ "$extracted_date" != "" ]; then
                last_updated="$extracted_date"
            fi
        else
            local extracted_date=$(grep -o '"last_updated"[[:space:]]*:[[:space:]]*"[^"]*"' "$last_updated_file" 2>/dev/null | head -1)
            
            if [ -n "$extracted_date" ]; then
                last_updated=$(echo "$extracted_date" | sed 's/.*"last_updated"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/')
            else
                local first_line=$(head -1 "$last_updated_file" 2>/dev/null)
                if echo "$first_line" | grep -qE '[0-9]{4}-[0-9]{2}-[0-9]{2}'; then
                    last_updated="$first_line"
                fi
            fi
        fi
    fi
            
    # Format tanggal dan waktu untuk jadwal
    local TODAY
    TODAY=$(date +"%d-%m-%Y")
    
    # TAMBAHKAN: Dapatkan tanggal Hijriyah dan nama hari
    local HIJRI_DATE=""
    local DAY_NAME=""
    
    # Dapatkan tanggal Hijriyah
    HIJRI_DATE=$(get_hijri_date 2>/dev/null || echo "")
    
    # Dapatkan nama hari dalam bahasa Indonesia
    local day_number=$(date +%u)
    case $day_number in
        1) DAY_NAME="Senin" ;;
        2) DAY_NAME="Selasa" ;;
        3) DAY_NAME="Rabu" ;;
        4) DAY_NAME="Kamis" ;;
        5) DAY_NAME="Jumat" ;;
        6) DAY_NAME="Sabtu" ;;
        7) DAY_NAME="Ahad" ;;
        *) DAY_NAME="Tidak Diketahui" ;;
    esac
    
    # Dapatkan nama bulan dalam bahasa Indonesia
    local month_number=$(date +%m)
    local month_name=""
    case $month_number in
        01) month_name="Januari" ;;
        02) month_name="Februari" ;;
        03) month_name="Maret" ;;
        04) month_name="April" ;;
        05) month_name="Mei" ;;
        06) month_name="Juni" ;;
        07) month_name="Juli" ;;
        08) month_name="Agustus" ;;
        09) month_name="September" ;;
        10) month_name="Oktober" ;;
        11) month_name="November" ;;
        12) month_name="Desember" ;;
        *) month_name="Tidak Diketahui" ;;
    esac
    
    # Format tanggal lengkap Gregorian
    local day_number_date=$(date +%d)
    local year_gregorian=$(date +%Y)
    local FULL_GREGORIAN_DATE="${day_number_date} ${month_name} ${year_gregorian}"
    
    local JADWAL
    JADWAL=$(uci get jsholat.schedule.file_jadwal 2>/dev/null)
    local CITY
    CITY=$(uci get jsholat.schedule.city_label 2>/dev/null || echo "Unknown")
    local PROVINCE
    PROVINCE=$(uci get jsholat.schedule.province 2>/dev/null || echo "Unknown")
    
    # Inisialisasi variabel jadwal
    local IMSYAK="" SHUBUH="" DZUHUR="" ASHAR="" MAGHRIB="" ISYA=""
    
    # Cek jadwal hari ini
    if [ -f "$JADWAL" ] && [ -r "$JADWAL" ]; then
        local JADWAL_LINE
        JADWAL_LINE=$(grep "^$TODAY" "$JADWAL" 2>/dev/null | tr -d '\r')
        if [ -n "$JADWAL_LINE" ]; then
            IMSYAK=$(echo "$JADWAL_LINE" | awk '{print $2}' | tr -d '\r')
            SHUBUH=$(echo "$JADWAL_LINE" | awk '{print $3}' | tr -d '\r')
            DZUHUR=$(echo "$JADWAL_LINE" | awk '{print $4}' | tr -d '\r')
            ASHAR=$(echo "$JADWAL_LINE" | awk '{print $5}' | tr -d '\r')
            MAGHRIB=$(echo "$JADWAL_LINE" | awk '{print $6}' | tr -d '\r')
            ISYA=$(echo "$JADWAL_LINE" | awk '{print $7}' | tr -d '\r')
        fi
    fi
    
    # Tentukan waktu sholat berikutnya yang benar
    local next_prayer=""
    local next_prayer_time=""
    local minutes_to_next="0"
    
    # Hanya cek jika ada jadwal
    if [ -n "$IMSYAK" ] && [ "$IMSYAK" != "-" ]; then
        local current_time
        current_time=$(date +"%H:%M")
        local current_seconds
        current_seconds=$(time_to_seconds "$current_time")
        
        # Cari waktu sholat berikutnya - TANPA ARRAY (untuk kompatibilitas shell)
        local prayer_found="0"
        
        # Cek Imsyak
        if [ -n "$IMSYAK" ] && [ "$prayer_found" = "0" ]; then
            local prayer_seconds
            prayer_seconds=$(time_to_seconds "$IMSYAK")
            if [ "$prayer_seconds" -gt "$current_seconds" ]; then
                next_prayer="Imsyak"
                next_prayer_time="$IMSYAK"
                minutes_to_next=$(( (prayer_seconds - current_seconds) / 60 ))
                prayer_found="1"
            fi
        fi
        
        # Cek Subuh
        if [ -n "$SHUBUH" ] && [ "$prayer_found" = "0" ]; then
            local prayer_seconds
            prayer_seconds=$(time_to_seconds "$SHUBUH")
            if [ "$prayer_seconds" -gt "$current_seconds" ]; then
                next_prayer="Subuh"
                next_prayer_time="$SHUBUH"
                minutes_to_next=$(( (prayer_seconds - current_seconds) / 60 ))
                prayer_found="1"
            fi
        fi
        
        # Cek Dzuhur
        if [ -n "$DZUHUR" ] && [ "$prayer_found" = "0" ]; then
            local prayer_seconds
            prayer_seconds=$(time_to_seconds "$DZUHUR")
            if [ "$prayer_seconds" -gt "$current_seconds" ]; then
                next_prayer="Dzuhur"
                next_prayer_time="$DZUHUR"
                minutes_to_next=$(( (prayer_seconds - current_seconds) / 60 ))
                prayer_found="1"
            fi
        fi
        
        # Cek Ashar
        if [ -n "$ASHAR" ] && [ "$prayer_found" = "0" ]; then
            local prayer_seconds
            prayer_seconds=$(time_to_seconds "$ASHAR")
            if [ "$prayer_seconds" -gt "$current_seconds" ]; then
                next_prayer="Ashar"
                next_prayer_time="$ASHAR"
                minutes_to_next=$(( (prayer_seconds - current_seconds) / 60 ))
                prayer_found="1"
            fi
        fi
        
        # Cek Maghrib
        if [ -n "$MAGHRIB" ] && [ "$prayer_found" = "0" ]; then
            local prayer_seconds
            prayer_seconds=$(time_to_seconds "$MAGHRIB")
            if [ "$prayer_seconds" -gt "$current_seconds" ]; then
                next_prayer="Maghrib"
                next_prayer_time="$MAGHRIB"
                minutes_to_next=$(( (prayer_seconds - current_seconds) / 60 ))
                prayer_found="1"
            fi
        fi
        
        # Cek Isya
        if [ -n "$ISYA" ] && [ "$prayer_found" = "0" ]; then
            local prayer_seconds
            prayer_seconds=$(time_to_seconds "$ISYA")
            if [ "$prayer_seconds" -gt "$current_seconds" ]; then
                next_prayer="Isya"
                next_prayer_time="$ISYA"
                minutes_to_next=$(( (prayer_seconds - current_seconds) / 60 ))
                prayer_found="1"
            fi
        fi
        
        # Jika tidak ada waktu sholat yang lebih besar dari sekarang, ambil sholat pertama besok (Imsyak)
        if [ "$prayer_found" = "0" ]; then
            next_prayer="Imsyak (besok)"
            next_prayer_time="$IMSYAK"
            # Hitung selisih sampai Imsyak besok
            local midnight_seconds=$((24 * 3600))
            local seconds_to_midnight=$((midnight_seconds - current_seconds))
            local imsak_seconds=$(time_to_seconds "$IMSYAK")
            minutes_to_next=$(( (seconds_to_midnight + imsak_seconds) / 60 ))
        fi
    fi
    
    # Dapatkan info jsholat-bot berdasarkan file PID
    local bot_info_raw
    bot_info_raw=$(get_jsholat_bot_status)

    # Parse status bot secara manual
    local bot_status="stopped"
    local bot_pid=""
    local bot_running="0"

    case "$bot_info_raw" in
        running:*)
            bot_status="running"
            bot_pid="${bot_info_raw#running:}"
            bot_running="1"
            ;;
        *)
            bot_status="$bot_info_raw"
            ;;
    esac
    
    # Dapatkan konfigurasi telegram (untuk display purposes only)
    local bot_enabled=$(uci -q get jsholat.service.telegram_enabled || echo "1")
    local bot_token=$(uci -q get jsholat.service.telegram_bot_token || echo "")
    local bot_chat_id=$(uci -q get jsholat.service.telegram_chat_id || echo "")
    
    # Dapatkan info bot lainnya
    local bot_uptime="0"
    local bot_start_time="Unknown"
    local bot_memory="0"
    local bot_log_file="/var/log/jsholat/bot.log"
    
    if [ "$bot_running" = "1" ] && [ -n "$bot_pid" ]; then
        # Hitung uptime dari /proc
        if [ -d "/proc/$bot_pid" ]; then
            local start_time
            start_time=$(stat -c %Y "/proc/$bot_pid" 2>/dev/null)
            if [ -n "$start_time" ]; then
                local now
                now=$(date +%s)
                bot_uptime=$((now - start_time))
                bot_start_time=$(date -d "@$start_time" "+%Y-%m-%d %H:%M:%S" 2>/dev/null || echo "Unknown")
            fi
            
            # Dapatkan penggunaan memory
            if [ -f "/proc/$bot_pid/status" ]; then
                local memory_kb
                memory_kb=$(grep VmRSS "/proc/$bot_pid/status" 2>/dev/null | awk '{print $2}')
                if [ -n "$memory_kb" ]; then
                    bot_memory=$((memory_kb / 1024))
                fi
            fi
        fi
    fi
    
    # Cek apakah bot configured (punya token dan chat ID)
    local bot_configured="0"
    if [ -n "$bot_token" ] && [ -n "$bot_chat_id" ]; then
        bot_configured="1"
    fi
    
    # Cek log file bot
    local bot_log_size="0"
    local bot_log_lines="0"
    
    if [ -f "$bot_log_file" ]; then
        bot_log_size=$(du -h "$bot_log_file" 2>/dev/null | awk '{print $1}' || echo "0")
        bot_log_lines=$(wc -l < "$bot_log_file" 2>/dev/null || echo "0")
    fi
    
    # Dapatkan variabel lain yang dibutuhkan
    local TIMEZONE
    TIMEZONE=$(uci -q get jsholat.schedule.timezone_value || echo "")
    local NOW
    NOW=$(date +"%H:%M")
    local system_uptime="0"
    
    if [ -f "/proc/uptime" ]; then
        system_uptime=$(awk '{print int($1)}' /proc/uptime 2>/dev/null || echo "0")
    fi
    
    # Dapatkan log info jsholat
    local log_size="0"
    local log_lines="0"
    if [ -f "/var/log/jsholat/service.log" ]; then
        log_size=$(du -h "/var/log/jsholat/service.log" 2>/dev/null | awk '{print $1}' || echo "0")
        log_lines=$(wc -l < "/var/log/jsholat/service.log" 2>/dev/null || echo "0")
    fi
    
    # Dapatkan informasi memori sistem
    local memory_human=$(get_system_memory_info 2>/dev/null)
    # Escape karakter khusus untuk JSON
    memory_human=$(echo "$memory_human" | sed 's/"/\\"/g; s/\\/\\\\/g')
    
    # Dapatkan informasi memori terstruktur untuk detail
    local memory_total_kb=0
    local memory_used_kb=0
    local memory_available_kb=0
    local memory_used_percent=0
    
    if [ -f "/proc/meminfo" ]; then
        memory_total_kb=$(grep -E '^MemTotal:' /proc/meminfo 2>/dev/null | awk '{print $2}')
        memory_available_kb=$(grep -E '^MemAvailable:' /proc/meminfo 2>/dev/null | awk '{print $2}')
        
        if [ -n "$memory_total_kb" ] && [ -n "$memory_available_kb" ]; then
            memory_used_kb=$((memory_total_kb - memory_available_kb))
            if [ "$memory_total_kb" -gt 0 ]; then
                memory_used_percent=$(( (memory_used_kb * 100) / memory_total_kb ))
            fi
        fi
    fi
    
    # Escape karakter khusus dalam string untuk JSON
    escaped_city=$(echo "$CITY" | sed 's/"/\\"/g; s/\\/\\\\/g')
    escaped_province=$(echo "$PROVINCE" | sed 's/"/\\"/g; s/\\/\\\\/g')
    escaped_next_prayer=$(echo "$next_prayer" | sed 's/"/\\"/g; s/\\/\\\\/g')
    escaped_hijri_date=$(echo "$HIJRI_DATE" | sed 's/"/\\"/g; s/\\/\\\\/g')
    escaped_day_name=$(echo "$DAY_NAME" | sed 's/"/\\"/g; s/\\/\\\\/g')
    escaped_full_gregorian=$(echo "$FULL_GREGORIAN_DATE" | sed 's/"/\\"/g; s/\\/\\\\/g')
    
    # Buat output JSON secara manual dengan tambahan informasi hijriyah
    cat <<EOF
{
    "services": {
        "jsholat": {
            "name": "jsholat",
            "enabled": "$service_enabled",
            "running": "$service_running",
            "pid": "${pid:-0}",
            "uptime": "$uptime_seconds",
            "start_time": "$start_time_str",
            "description": "Jadwal Sholat dan Pemutar Adzan Otomatis"
        },
        "jsholat-bot": {
            "name": "jsholat-bot",
            "running": "$bot_running",
            "pid": "$bot_pid",
            "uptime": "$bot_uptime",
            "start_time": "$bot_start_time",
            "memory_mb": "$bot_memory",
            "log_file": "$bot_log_file",
            "description": "Bot Telegram Notifikasi",
            "telegram_notifications": "$bot_enabled",
            "configured": "$bot_configured"
        }
    },
    "config": {
        "telegram_enabled": "$bot_enabled",
        "telegram_configured": "$bot_configured",
        "sound": "$sound_enabled",
        "volume": "$volume_level",
        "ayat": "$ayat_enabled",
        "reminder": "$reminder_before",
        "debug": "$debug_mode"
    },
    "location": {
        "city": "$escaped_city",
        "province": "$escaped_province",
        "date": "$TODAY",
        "timezone": "$TIMEZONE"
    },
    "schedule": {
        "today": "$TODAY",
        "imsyak": "$IMSYAK",
        "subuh": "$SHUBUH",
        "dzuhur": "$DZUHUR",
        "ashar": "$ASHAR",
        "maghrib": "$MAGHRIB",
        "isya": "$ISYA",
        "schedule_source": "$schedule_source",
        "source": "$source_alias",
        "file": "$schedule_file",
        "last_updated": "$last_updated"
    },
    "next_prayer": {
        "name": "$escaped_next_prayer",
        "time": "$next_prayer_time",
        "minutes_left": "$minutes_to_next"
    },
    "system": {
        "current_time": "$NOW",
        "uptime": "$system_uptime",
        "date": {
            "day_name": "$escaped_day_name",
            "gregorian_date": "$escaped_full_gregorian",
            "hijri_date": "$escaped_hijri_date",
        }, 
        "memory": {
            "total_kb": "$memory_total_kb",
            "total_mb": "$((memory_total_kb / 1024))",
            "used_kb": "$memory_used_kb",
            "used_mb": "$((memory_used_kb / 1024))",
            "available_kb": "$memory_available_kb",
            "available_mb": "$((memory_available_kb / 1024))",
            "used_percent": "$memory_used_percent",
            "human_readable": "$memory_human"
        },
        "jsholat_log": {
            "file": "/var/log/jsholat/service.log",
            "size": "$log_size",
            "lines": "$log_lines"
        },
        "bot_log": {
            "file": "$bot_log_file",
            "size": "$bot_log_size",
            "lines": "$bot_log_lines"
        }
    },
    "status": {
        "last_update": "$(date '+%Y-%m-%d %H:%M:%S')"
    }
}
EOF
}

# Fungsi konversi waktu ke detik yang lebih aman
time_to_seconds() {
    local time_str=$1
    
    # Pastikan input tidak kosong
    if [ -z "$time_str" ]; then
        log "ERROR" "‚ùå Waktu kosong"
        echo "0"
        return 1
    fi
    
    # Hapus semua karakter non-digit dan non-titik dua
    local clean_time=$(echo "$time_str" | tr -cd '0-9:')
    
    # Pastikan format HH:MM
    if ! echo "$clean_time" | grep -qE '^[0-9]{1,2}:[0-9]{2}$'; then
        log "ERROR" "‚ùå Format waktu tidak valid: '$time_str'"
        echo "0"
        return 1
    fi
    
    # Pisahkan jam dan menit
    local hours=${clean_time%:*}
    local minutes=${clean_time#*:}
    
    # Hilangkan leading zero dengan cara yang lebih kompatibel
    hours=${hours#0}
    minutes=${minutes#0}
    
    # Default ke 0 jika kosong (untuk case "00")
    [ -z "$hours" ] && hours=0
    [ -z "$minutes" ] && minutes=0
    
    # Validasi range
    if [ "$hours" -lt 0 ] || [ "$hours" -gt 23 ]; then
        log "ERROR" "‚ùå Jam tidak valid (0-23): $hours (dari input: '$time_str')"
        echo "0"
        return 1
    fi
    
    if [ "$minutes" -lt 0 ] || [ "$minutes" -gt 59 ]; then
        log "ERROR" "‚ùå Menit tidak valid (0-59): $minutes (dari input: '$time_str')"
        echo "0"
        return 1
    fi
    
    local total_seconds=$(( hours * 3600 + minutes * 60 ))
    [ "$DEBUG_MODE" = "1" ] && log "DEBUG" "Konversi '$time_str' -> $total_seconds detik"
    
    echo "$total_seconds"
    return 0
}

# Fungsi fleksibel nama sholat jum'at
get_salat_name() {
    local name="$1"
    local day=$(date +%u)
    
    # Ganti "Dzuhur" menjadi "Jumat" saat hari Jumat
    if [ "$name" = "Dzuhur" ] && [ "$day" -eq 5 ]; then
        echo "Jumat"
    else
        echo "$name"
    fi
}


# Fungsi Inisialisasi Log
init_log_system() {
    [ -d "$LOG_DIR" ] || mkdir -p "$LOG_DIR"
    [ -f "$LOG_FILE" ] || touch "$LOG_FILE"
    chmod 644 "$LOG_FILE"
}

# Fungsi bot telegram
send_telegram() {
    local telegram_enabled=$(uci -q get jsholat.service.telegram_enabled || echo "1")
    if [ "$telegram_enabled" = "0" ]; then
        log "INFO" "üîï Notifikasi Telegram dinonaktifkan"
		[ "$DEBUG_MODE" = "1" ] && log "DEBUG" "üîï Notifikasi Telegram dinonaktifkan"
        return
    fi

    local message="$1"
    local telegram_token=$(uci get jsholat.service.telegram_bot_token 2>/dev/null)
    local chat_id=$(uci get jsholat.service.telegram_chat_id 2>/dev/null)
    
    if [ -z "$telegram_token" ] || [ -z "$chat_id" ]; then
        log "ERROR" "‚ùå Telegram token/chat ID belum diatur!"
        return
    fi

    curl -s --connect-timeout 10 --max-time 15 -X POST \
        "https://api.telegram.org/bot${telegram_token}/sendMessage" \
        -d chat_id="${chat_id}" \
        -d text="${message}" \
        -d parse_mode="Markdown" \
        > /dev/null 2>&1
        
    if [ $? -ne 0 ]; then
        log "ERROR" "‚ùå Gagal mengirim notifikasi Telegram"
    else
        log "INFO" "üì¢ Notifikasi Telegram terkirim"
    fi
}

# Fungsi Logging Terstruktur
log() {
    local level=$1
    local message=$2
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    # Rotasi log jika melebihi ukuran maksimal
    if [ -f "$LOG_FILE" ] && [ $(wc -c < "$LOG_FILE") -gt $MAX_LOG_SIZE ]; then
        mv "$LOG_FILE" "$LOG_FILE.old"
        touch "$LOG_FILE"
        chmod 644 "$LOG_FILE"
    fi
    
    echo "[$timestamp] [$level] $message" >> "$LOG_FILE"
    logger -t "jsholat[$level]" "$message"
}

# Fungsi Validasi File
validate_file() {
    local file_path=$1
    local file_desc=$2
    
    if [ -z "$file_path" ]; then
        log "ERROR" "‚ùå Path $file_desc tidak boleh kosong"
        return 1
    fi
    
    if [ ! -f "$file_path" ]; then
        log "ERROR" "‚ùå File $file_desc tidak ditemukan: $file_path"
        return 1
    fi
    
    if [ ! -r "$file_path" ]; then
        log "ERROR" "‚ùå File $file_desc tidak bisa dibaca: $file_path"
        return 1
    fi
    
    [ "$DEBUG_MODE" = "1" ] && log "DEBUG" "File $file_desc valid: $file_path"
    return 0
}

# Fungsi untuk mendapatkan ayat acak dari API myquran
get_random_ayat() {
    local api_url="https://api.myquran.com/v2/quran/ayat/acak"
    local response=$(curl -s "$api_url")

    [ -z "$response" ] && { log "ERROR" "Gagal mengambil ayat acak"; echo ""; return 1; }

    local surah_name=$(echo "$response" | jq -r '.data.info.surat.nama.id')
    local ayat_number=$(echo "$response" | jq -r '.data.ayat.ayah')
    local ayat_text=$(echo "$response" | jq -r '.data.ayat.text')
    local ayat_arab=$(echo "$response" | jq -r '.data.ayat.arab')
    local ayat_latin=$(echo "$response" | jq -r '.data.ayat.latin')
    local ayat_notes=$(echo "$response" | jq -r '.data.ayat.notes')

    # Format pesan dengan Markdown
    local formatted_ayat="
*üìñ QS ${surah_name}:${ayat_number}*

\`${ayat_arab}\`

*${ayat_latin}*

*Artinya:* \"${ayat_text}\""

    # Tambahkan catatan jika ada
    if [ -n "$ayat_notes" ] && [ "$ayat_notes" != "null" ]; then
        formatted_ayat+="

üìù _${ayat_notes}_"
    fi

    # Return teks 
    echo "${formatted_ayat}"
    return 0
}

# Fungsi untuk memutar audio ayat
play_audio_ayat() {
    local audio_url="$1"
    local ayat_enabled=$(uci -q get jsholat.service.ayat_enabled || echo "1")
    local sound_enabled=$(uci -q get jsholat.service.sound_enabled || echo "1")
    
    # Cek status fitur
    if [ "$ayat_enabled" = "0" ] || [ "$sound_enabled" = "0" ]; then
        log "INFO" "üîá Audio ayat dinonaktifkan"
        [ "$DEBUG_MODE" = "1" ] && log "DEBUG" "üîá Audio ayat dinonaktifkan (ayat_enabled=$ayat_enabled, sound_enabled=$sound_enabled)"
        return
    fi

    [ -z "$audio_url" ] && { log "ERROR" "URL audio ayat kosong"; return 1; }

    # Gunakan pengaturan volume adzan
    local volume_control=$(uci -q get jsholat.sound.volume_control || echo "hardware")
    local volume_level=$(uci -q get jsholat.sound.volume_level || echo "80")
    local mixer_device=$(uci -q get jsholat.sound.mixer_device || echo "Speaker")

    # Set volume sesuai setting adzan
    if [ "$volume_control" = "hardware" ]; then
        amixer -q set "$mixer_device" ${volume_level}% >/dev/null 2>&1 || 
        log "ERROR" "‚ùå Gagal set volume hardware"
    fi

    log "INFO" "üîä Memutar audio ayat (Mengikuti volume adzan: $volume_level%)"

    # Pemutaran audio dengan manajemen resource
    local temp_audio=$(mktemp "/tmp/ayat_audio_$(date +%s).mp3")
    if wget -q -O "$temp_audio" "$audio_url"; then
        (
            timeout 30 madplay "$temp_audio" >/dev/null 2>&1  # Batasi 30 detik
            rm -f "$temp_audio"
            [ "$DEBUG_MODE" = "1" ] && log "DEBUG" "‚úÖ Audio ayat selesai"
        ) & # Jalankan di background
    else
        log "ERROR" "‚ùå Gagal download audio ayat"
        rm -f "$temp_audio"
    fi
}

# Fungsi Pemutar Adzan dengan Fallback
play_adzan() {
    if [ $# -lt 3 ]; then
        log "ERROR" "Parameter kurang untuk play_adzan: file_path=$1, salat_name=$2, prayer_time=$3"
        return 1
    fi

    local file_path="$1"
    local salat_name="$2"
    local prayer_time="$3"
    local timezone=$(uci -q get jsholat.schedule.timezone_value || echo "") 
    local timezone_display=""
    [ -n "$timezone" ] && timezone_display=" $timezone"
    local LOKASI=$(uci get jsholat.schedule.city_label 2>/dev/null || echo "Wilayah Tidak Diketahui")

    # ‚úÖ 1. KIRIM NOTIFIKASI JIKA TELEGRAM ENABLED
    local telegram_enabled=$(uci -q get jsholat.service.telegram_enabled || echo "1")
    if [ "$telegram_enabled" = "1" ]; then
        # Format pesan khusus untuk Imsyak
        if [ "$salat_name" = "Imsyak" ]; then
            send_telegram "üïå *SAATNYA WAKTU IMSYAK*
  
‚è∞ *$salat_name*: $prayer_time$timezone_display
üìç Untuk Wilayah: *$LOKASI* dan sekitarnya."
        else
            # Format pesan untuk waktu sholat lainnya
            send_telegram "üïå *SAATNYA WAKTU SHOLAT ${salat_name}*
  
‚è∞ *$salat_name*: $prayer_time$timezone_display
üìç Untuk Wilayah: *$LOKASI* dan sekitarnya.
  
Selamat menunaikan sholat *$salat_name*.
*Semoga Allah menerima ibadah kita* ü§≤"
        fi
    else
	log "INFO" "üîï Notifikasi waktu sholat dinonaktifkan"
        [ "$DEBUG_MODE" = "1" ] && log "DEBUG" "üîï Notifikasi waktu sholat dinonaktifkan"
    fi
       
    log "INFO" "‚è∞ WAKTU SHOLAT: Saatnya waktu $salat_name untuk wilayah $LOKASI pada $prayer_time$timezone_display."
    
    # ‚úÖ 2. CEK SOUND ENABLED UNTUK PEMUTARAN AUDIO
    local sound_enabled=$(uci -q get jsholat.sound.sound_enabled || echo "1")
    if [ "$sound_enabled" = "0" ]; then
        log "INFO" "üîá Pemutaran suara dinonaktifkan"
        return 0
    fi
    
    local volume_control=$(uci -q get jsholat.sound.volume_control || echo "hardware")
    local volume_level=$(uci -q get jsholat.sound.volume_level || echo "80")
    local mixer_device=$(uci -q get jsholat.sound.mixer_device || echo "PCM")

    # Set volume sebelum memutar (jika mode hardware)
    if [ "$volume_control" = "hardware" ]; then
        if ! amixer -q set "$mixer_device" ${volume_level}% >/dev/null 2>&1; then
            log "ERROR" "‚ùå Gagal mengatur volume hardware"
        else
            log "INFO" "üîä Mengatur volume hardware ke $volume_level% (device: $mixer_device)"
        fi
    fi

    if [ "$sound_enabled" = "1" ]; then
        log "INFO" "‚è∞ WAKTU SHOLAT: Memutar suara untuk $salat_name"
        
        # Fungsi internal untuk mencoba memutar audio dengan berbagai metode
        try_play_audio() {
            local audio_file="$1"
            
            # Coba madplay pertama
            if command -v madplay >/dev/null 2>&1; then
                log "INFO" "‚ñ∂ Mencoba memutar dengan madplay..."
                if madplay "$audio_file" >/dev/null 2>&1; then
                    return 0
                fi
            fi            
            
            # Fallback 1: mpg123 (jika tersedia)
            if command -v mpg123 >/dev/null 2>&1; then
                log "INFO" "üîÅ Fallback ke mpg123..."
                if mpg123 -q "$audio_file" >/dev/null 2>&1; then
                    return 0
                fi
            fi          
            
            return 1
        }
        
        if echo "$file_path" | grep -q "http"; then
            local temp_dir="/tmp/adzan_$(date +%s)"
            mkdir -p "$temp_dir"
            
            if wget -q -P "$temp_dir" "$file_path"; then
                local downloaded_file=$(ls "$temp_dir" | head -n1)
                if [ -n "$downloaded_file" ]; then
                    log "INFO" "üîä Memainkan adzan dari URL: $file_path"
                    if ! try_play_audio "$temp_dir/$downloaded_file"; then
                        log "ERROR" "‚ùå Semua metode pemutaran audio gagal"
                    fi
                    rm -rf "$temp_dir"
                else
                    log "ERROR" "‚ùå Gagal mendownload file adzan"
                fi
            else
                log "ERROR" "‚ùå Gagal mendownload dari URL: $file_path"
            fi
        else
            if [ -f "$file_path" ]; then
                log "INFO" "üîä Memainkan adzan dari file lokal: $file_path"
                if ! try_play_audio "$file_path"; then
                    log "ERROR" "‚ùå Semua metode pemutaran audio gagal"
                fi
            else
                log "ERROR" "‚ùå File adzan tidak ditemukan: $file_path"
            fi
        fi
    fi
    
    # Reset volume ke default setelah selesai (opsional)
    [ "$volume_control" = "hardware" ] && amixer -q set "$mixer_device" 80% >/dev/null 2>&1
    
    log "INFO" "‚úÖ Selesai memainkan adzan untuk $salat_name"
}

# Fungsi Peringatan Sebelum Waktu Sholat
reminder_before_prayer() {
    local salat_name="$1"
    local prayer_time="$2"
    local timezone=$(uci -q get jsholat.schedule.timezone_value || echo "")
    local reminder_mins=$(uci -q get jsholat.sound.reminder_before || echo "5")
    local LOKASI=$(uci get jsholat.schedule.city_label 2>/dev/null || echo "Wilayah Tidak Diketahui")
    local ayat_enabled=$(uci -q get jsholat.service.ayat_enabled || echo "1")
    local telegram_enabled=$(uci -q get jsholat.service.telegram_enabled || echo "1")
    
    # ‚úÖ CEK JIKA REMINDER DINONAKTIFKAN (nilai 0)
    if [ "$reminder_mins" = "0" ]; then
        [ "$DEBUG_MODE" = "1" ] && log "DEBUG" "üîï Fitur reminder dinonaktifkan untuk semua waktu sholat"
        return 1
    fi
    
    # Skip jika reminder sudah dikirim
    case "$salat_name" in
        "Imsyak") [ "$REMINDER_IMSYAK" -eq 1 ] && return 1 ;;
        "Subuh") [ "$REMINDER_SUBUH" -eq 1 ] && return 1 ;;
        "Dzuhur"|"Jumat") [ "$REMINDER_DZUHUR" -eq 1 ] && return 1 ;;
        "Ashar") [ "$REMINDER_ASHAR" -eq 1 ] && return 1 ;;
        "Maghrib") [ "$REMINDER_MAGHRIB" -eq 1 ] && return 1 ;;
        "Isya") [ "$REMINDER_ISYA" -eq 1 ] && return 1 ;;
    esac

    # Konversi waktu ke detik dengan validasi
    local prayer_sec=$(time_to_seconds "$prayer_time")
    [ "$prayer_sec" -eq 0 ] && return 1
    
    local reminder_sec=$((prayer_sec - reminder_mins * 60))
    
    # Waktu sekarang dalam detik
    local current_time=$(date +"%H:%M")
    local current_sec=$(time_to_seconds "$current_time")
    [ "$current_sec" -eq 0 ] && return 1
    
    if [ "$current_sec" -ge "$reminder_sec" ] && [ "$current_sec" -lt "$prayer_sec" ]; then
        log "INFO" "üîî REMINDER: Waktu $salat_name untuk wilayah $LOKASI akan tiba dalam $reminder_mins menit ($prayer_time)"

        # Kirim notifikasi jika telegram enabled
        if [ "$telegram_enabled" = "1" ]; then
            # Format pesan dengan pengecekan timezone
            local timezone_display=""
            [ -n "$timezone" ] && timezone_display=" $timezone"

            # Kirim reminder terlebih dahulu
            local reminder_message=""
            if [ "$salat_name" = "Imsyak" ]; then
                reminder_message="üîî *PENGINGAT SHOLAT*
  
Waktu *$salat_name* akan tiba dalam *$reminder_mins menit*!  
üïí Pukul: $prayer_time$timezone_display
üìç Untuk Wilayah: *$LOKASI* dan sekitarnya."
            else
                reminder_message="üîî *PENGINGAT SHOLAT*
  
Waktu *$salat_name* akan tiba dalam *$reminder_mins menit*!  
üïí Pukul: $prayer_time$timezone_display
üìç Untuk Wilayah: *$LOKASI* dan sekitarnya.

*Siapkan diri untuk sholat*
*Jangan lupa wudhu* üíß"
            fi

            send_telegram "$reminder_message"

            # Kirim ayat acak terpisah jika fitur aktif
            if [ "$ayat_enabled" = "1" ]; then
                local random_ayat=$(get_random_ayat)
                if [ -n "$random_ayat" ]; then
                    send_telegram "$(printf "üí´ *Ayat Pilihan Hari Ini*\n%s" "$random_ayat")"
                fi
            fi
        else
            [ "$DEBUG_MODE" = "1" ] && log "DEBUG" "üîï Notifikasi reminder dinonaktifkan"
        fi
        
        # Tandai reminder sudah dikirim
        case "$salat_name" in
            "Imsyak") REMINDER_IMSYAK=1 ;;
            "Subuh") REMINDER_SUBUH=1 ;;
            "Jumat") REMINDER_DZUHUR=1 ;;
            "Dzuhur") REMINDER_DZUHUR=1 ;;
            "Ashar") REMINDER_ASHAR=1 ;;
            "Maghrib") REMINDER_MAGHRIB=1 ;;
            "Isya") REMINDER_ISYA=1 ;;
        esac
        save_reminder_status
        return 0
    fi
    
    # Reset status reminder jika sudah lewat waktu sholat
    if [ "$current_sec" -ge "$prayer_sec" ]; then
        case "$salat_name" in
            "Imsyak") REMINDER_IMSYAK=0 ;;
            "Subuh") REMINDER_SUBUH=0 ;;
            "Dzuhur") REMINDER_DZUHUR=0 ;;
            "Ashar") REMINDER_ASHAR=0 ;;
            "Maghrib") REMINDER_MAGHRIB=0 ;;
            "Isya") REMINDER_ISYA=0 ;;
        esac
        save_reminder_status
    fi
    
    return 1
}

# Fungsi Utama Service
run_service() {
    init_log_system
    # Jangan reset di sini, tapi load status yang ada
    load_reminder_status  # ‚úÖ LOAD STATUS YANG ADA
    reset_reminder_status  # ‚úÖ RESET HANYA JIKA HARI BERBEDA
	
    log "INFO" "=========== SERVICE JSHOLAT DIMULAI ==========="
    log "INFO" "üìä Status Reminder: Imsyak=$REMINDER_IMSYAK, Subuh=$REMINDER_SUBUH, Dzuhur=$REMINDER_DZUHUR, Ashar=$REMINDER_ASHAR, Maghrib=$REMINDER_MAGHRIB, Isya=$REMINDER_ISYA"
    
	# Load konfigurasi
    local JADWAL=$(uci get jsholat.schedule.file_jadwal 2>/dev/null)
    local FILE_ADZAN=$(uci get jsholat.sound.sound_adzan 2>/dev/null)
    local FILE_ADZAN_SHUBUH=$(uci get jsholat.sound.sound_adzan_shubuh 2>/dev/null)
    local FILE_IMSYAK=$(uci get jsholat.sound.sound_adzan_imsy 2>/dev/null)
    local LOKASI=$(uci get jsholat.schedule.city_label 2>/dev/null)
    local TIMEZONE=$(uci -q get jsholat.schedule.timezone_value || echo "")
    local SUMBER=$(uci get jsholat.schedule.source 2>/dev/null)
	local REMINDER_BEFORE=$(uci -q get jsholat.sound.reminder_before || echo "15")
    DEBUG_MODE=$(uci -q get jsholat.service.debug_mode || echo "0")
    
    # Tambahan: Load konfigurasi kontrol fitur
    local TELEGRAM_ENABLED=$(uci -q get jsholat.service.telegram_enabled || echo "1")
    local SOUND_ENABLED=$(uci -q get jsholat.sound.sound_enabled || echo "1")
    local SERVICE_ENABLED=$(uci -q get jsholat.service.service || echo "1")
    
    # Log status fitur
	log "INFO" "‚öôÔ∏è Status Fitur:"
	log "INFO" " - Service: $([ "$SERVICE_ENABLED" = "1" ] && echo "AKTIF" || echo "NONAKTIF")"
	log "INFO" " - Notifikasi Telegram: $([ "$TELEGRAM_ENABLED" = "1" ] && echo "AKTIF" || echo "NONAKTIF")"
	log "INFO" " - Pemutar Suara: $([ "$SOUND_ENABLED" = "1" ] && echo "AKTIF" || echo "NONAKTIF")"
	log "INFO" " - Reminder Sholat: $([ "$REMINDER_BEFORE" = "0" ] && echo "NONAKTIF" || echo "AKTIF (${REMINDER_BEFORE} menit)")"
	log "INFO" " - Ayat Acak: $([ "$AYAT_ENABLED" = "1" ] && echo "AKTIF" || echo "NONAKTIF")"
	log "INFO" " - Debug Mode: $([ "$DEBUG_MODE" = "1" ] && echo "AKTIF" || echo "NONAKTIF")"
    
    # Validasi file
	# HANYA cek file audio kalau pemutar suara aktif
	if [ "$SOUND_ENABLED" = "1" ]; then
		validate_file "$JADWAL" "Jadwal Sholat" || exit 1
		validate_file "$FILE_ADZAN" "Suara Adzan" || exit 1
		validate_file "$FILE_ADZAN_SHUBUH" "Suara Adzan Subuh" || exit 1
		validate_file "$FILE_IMSYAK" "Suara Imsyak" || exit 1
	fi	
    
    # Log konfigurasi 
    log "INFO" "‚öôÔ∏è Konfigurasi yang digunakan:"
    log "INFO" " - File Jadwal: $JADWAL"
    log "INFO" " - Sumber Jadwal: $SUMBER"
    log "INFO" " - Wilayah: $LOKASI"
    log "INFO" " - Zona Waktu: $TIMEZONE"
    log "INFO" " - File Adzan: $FILE_ADZAN"
    log "INFO" " - File Adzan Subuh: $FILE_ADZAN_SHUBUH"
    log "INFO" " - File Imsyak: $FILE_IMSYAK"
    
    local CURRENT_DATE=""
    local IMSYAK="" SHUBUH="" DZUHUR="" ASHAR="" MAGHRIB="" ISYA=""
    local LAST_DATE=""
    
    # Main Service Loop
    while true; do
        local service_enabled=$(uci -q get jsholat.service.service || echo "1")	
		local REMINDER_BEFORE=$(uci -q get jsholat.sound.reminder_before || echo "5")
        if [ "$service_enabled" = "0" ]; then
            log "INFO" "Service dinonaktifkan, menunggu 60 detik..."
            sleep 60
            continue
        fi

        local TODAY=$(date +"%d-%m-%Y")
        local CURRENT_TIME=$(date +"%H:%M")
        
        # Reset reminder status jika hari berganti
        if [ "$LAST_DATE" != "$TODAY" ]; then
            reset_reminder_status
            LAST_DATE="$TODAY"
        fi
        
        # Update jadwal jika tanggal berubah
        if [ "$CURRENT_DATE" != "$TODAY" ]; then
            log "INFO" "üìÖ Mengupdate jadwal untuk tanggal $TODAY"
            
            # Bersihkan karakter khusus dari file jadwal
            local JADWAL_LINE=$(grep "^$TODAY" "$JADWAL" 2>/dev/null | tr -d '\r')
            if [ -n "$JADWAL_LINE" ]; then
                CURRENT_DATE="$TODAY"
                IMSYAK=$(echo "$JADWAL_LINE" | awk '{print $2}' | tr -d '\r')
                SHUBUH=$(echo "$JADWAL_LINE" | awk '{print $3}' | tr -d '\r')
                DZUHUR=$(echo "$JADWAL_LINE" | awk '{print $4}' | tr -d '\r')
                ASHAR=$(echo "$JADWAL_LINE" | awk '{print $5}' | tr -d '\r')
                MAGHRIB=$(echo "$JADWAL_LINE" | awk '{print $6}' | tr -d '\r')
                ISYA=$(echo "$JADWAL_LINE" | awk '{print $7}' | tr -d '\r')
                
                # Validasi waktu sholat
                for waktu in "$IMSYAK" "$SHUBUH" "$DZUHUR" "$ASHAR" "$MAGHRIB" "$ISYA"; do
                    if ! time_to_seconds "$waktu" >/dev/null; then
                        log "ERROR" "‚ùå Waktu sholat tidak valid dalam jadwal: '$waktu' (full line: $JADWAL_LINE)"
                        sleep 300
                        continue 2
                    fi
                done
                
                log "INFO" "üïå Jadwal Sholat $TODAY untuk daerah $LOKASI:"
                log "INFO" " - Imsyak: $IMSYAK $TIMEZONE"
                log "INFO" " - Subuh: $SHUBUH $TIMEZONE"
                log "INFO" " - Dzuhur: $DZUHUR $TIMEZONE"
                log "INFO" " - Ashar: $ASHAR $TIMEZONE"
                log "INFO" " - Maghrib: $MAGHRIB $TIMEZONE"
                log "INFO" " - Isya: $ISYA $TIMEZONE"
            else
                log "ERROR" "‚ùå Jadwal tidak ditemukan untuk tanggal $TODAY"
                sleep 300
                continue
            fi
        fi
        
        # Cek waktu sholat dan reminder
        if [ "$CURRENT_TIME" = "$IMSYAK" ]; then
            play_adzan "$FILE_IMSYAK" "Imsyak" "$IMSYAK"
            sleep 60  # Tunggu 1 menit untuk menghindari multiple triggers
        elif [ "$CURRENT_TIME" = "$SHUBUH" ]; then
            play_adzan "$FILE_ADZAN_SHUBUH" "Subuh" "$SHUBUH"
            sleep 60
        elif [ "$CURRENT_TIME" = "$DZUHUR" ]; then
            local nama_sholat=$(get_salat_name "Dzuhur")
            play_adzan "$FILE_ADZAN" "$nama_sholat" "$DZUHUR"
            sleep 60
        elif [ "$CURRENT_TIME" = "$ASHAR" ]; then
            play_adzan "$FILE_ADZAN" "Ashar" "$ASHAR"
            sleep 60
        elif [ "$CURRENT_TIME" = "$MAGHRIB" ]; then
            play_adzan "$FILE_ADZAN" "Maghrib" "$MAGHRIB"
            sleep 60
        elif [ "$CURRENT_TIME" = "$ISYA" ]; then
            play_adzan "$FILE_ADZAN" "Isya" "$ISYA"
            sleep 60
        else
			# ‚úÖ HANYA CEK REMINDER JIKA FITUR AKTIF
			if [ "$REMINDER_BEFORE" != "0" ]; then
				reminder_before_prayer "Imsyak" "$IMSYAK"
				reminder_before_prayer "Subuh" "$SHUBUH"
				reminder_before_prayer "$(get_salat_name "Dzuhur")" "$DZUHUR" #cek jika hari Jumat
				reminder_before_prayer "Ashar" "$ASHAR"
				reminder_before_prayer "Maghrib" "$MAGHRIB"
				reminder_before_prayer "Isya" "$ISYA"
			else
				[ "$DEBUG_MODE" = "1" ] && log "DEBUG" "üîï Skip pengecekan reminder (fitur dinonaktifkan)"
			fi
		fi
        
        sleep 5
    done
}

# =============================================
# MAIN ENTRY POINT
# =============================================

case "$1" in
    "install")
        uci -q set jsholat.service.telegram_enabled=1
        uci -q set jsholat.sound.sound_enabled=1
        uci -q set jsholat.service.service=1
        uci commit jsholat
        
        mkdir -p "/var/log/jsholat"
        touch "/var/log/jsholat/service.log"
        chmod 644 "/var/log/jsholat/service.log"
        
        cp -f "$0" /usr/bin/jsholat
        chmod 755 /usr/bin/jsholat
        
cat > /etc/init.d/jsholat <<'EOF'
#!/bin/sh /etc/rc.common

USE_PROCD=1
START=20
STOP=90

start_service() {
    procd_open_instance
    procd_set_param command /usr/bin/jsholat run
    procd_set_param respawn 300 5
    procd_set_param stdout 1
    procd_set_param stderr 1
    procd_set_param file /var/log/jsholat/service.log
    procd_close_instance
}

stop_service() {
    pid=$(pgrep -f "/usr/bin/jsholat run")
    [ -n "$pid" ] && kill $pid
}
EOF

        chmod 755 /etc/init.d/jsholat
        /etc/init.d/jsholat enable
        /etc/init.d/jsholat start
        echo "Instalasi berhasil! Service jsholat telah diaktifkan."
        ;;
    "uninstall")
        opkg remove luci-app-jsholat
        rm -rf /var/lib/jsholat  
        echo "jsholat berhasil dihapus"
        ;;
    "run")
        run_service
        ;;
    "status")  # TAMBAHKAN COMMAND STATUS
        show_status
        ;;
    "info")  # TAMBAHKAN COMMAND STATUS
        info_service
        ;;
    *)
        echo "Usage: $0 {install|uninstall|run|info|status}"
        echo ""
        echo "Commands:"
        echo "  install   - Install service jsholat"
        echo "  uninstall - Hapus service jsholat"
        echo "  run       - Jalankan service secara langsung"
        echo "  status    - Tampilkan status service"
        echo "  info      - Tampilkan info service"
        exit 1
        ;;
esac

exit 0